// ============================================
// TG CHALLENGE BOT - Single File Version
// –ü—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π —ç—Ç–æ—Ç –∫–æ–¥ –≤ Cloudflare Dashboard
// ============================================

// –≠–º–æ–¥–∑–∏-–∏—Å–∫–ª—é—á–µ–Ω–∏–µ (–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è)
const EXCLUDED_EMOJI = "üåö";

// –†–µ–∂–∏–º—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–º
const CONTENT_MODES = {
  vanilla: { name: "üç¶ Vanilla", description: "–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑—Ä–∞—Å—Ç–æ–≤" },
  medium: { name: "üî• Medium", description: "–í–∑—Ä–æ—Å–ª—ã–µ —Ç–µ–º—ã –±–µ–∑ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (16+)" },
  nsfw: { name: "üåô Mature", description: "–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —ç—Ä–æ—Ç–∏–∫–∞ –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤ 21+" },
};
const DEFAULT_CONTENT_MODE = "vanilla";

// Russian pluralization helper
function pluralize(n, one, few, many) {
  const mod10 = Math.abs(n) % 10;
  const mod100 = Math.abs(n) % 100;
  if (mod10 === 1 && mod100 !== 11) return one;
  if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) return few;
  return many;
}

// ============================================
// –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================

const ru = {
  challengeTypes: {
    daily: "–ß–µ–ª–ª–µ–Ω–¥–∂ –¥–Ω—è",
    weekly: "–ß–µ–ª–ª–µ–Ω–¥–∂ –Ω–µ–¥–µ–ª–∏",
    monthly: "–ß–µ–ª–ª–µ–Ω–¥–∂ –º–µ—Å—è—Ü–∞",
  },
  pollQuestion: (type) => {
    const labels = {
      daily: "–¥–Ω–µ–≤–Ω–æ–≥–æ",
      weekly: "–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ",
      monthly: "–º–µ—Å—è—á–Ω–æ–≥–æ",
    };
    return `–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ —Ç–µ–º—É ${labels[type]} —á–µ–ª–ª–µ–Ω–¥–∂–∞`;
  },
  challengeAnnouncement: (type, topic, startDate, endDate, voteCount = 0) => {
    const labels = {
      daily: "–ß–ï–õ–õ–ï–ù–î–ñ –î–ù–Ø",
      weekly: "–ß–ï–õ–õ–ï–ù–î–ñ –ù–ï–î–ï–õ–ò",
      monthly: "–ß–ï–õ–õ–ï–ù–î–ñ –ú–ï–°–Ø–¶–ê",
    };
    const voteLine = voteCount > 0 ? ` (${voteCount} –≥–æ–ª–æ—Å–æ–≤)` : "";
    return `${labels[type]}
${startDate} ‚Äî ${endDate}

–¢–µ–º–∞: ${topic}${voteLine}

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —ç—Ç—É —Ç–µ–º—É –¥–ª—è —É—á–∞—Å—Ç–∏—è.
–õ—É—á—à–∞—è —Ä–∞–±–æ—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —Ä–µ–∞–∫—Ü–∏—è–º.
–†–µ–∞–∫—Ü–∏—è üåö –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è`;
  },
  // Extended winner announcement with full prompt for winners topic
  winnerAnnouncementFull: (username, score, type, topic, topicFull) => {
    const labels = {
      daily: "–¥–Ω–µ–≤–Ω–æ–≥–æ",
      weekly: "–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ",
      monthly: "–º–µ—Å—è—á–Ω–æ–≥–æ",
    };
    return `üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å ${labels[type]} —á–µ–ª–ª–µ–Ω–¥–∂–∞

${username} ‚Äî ${score} —Ä–µ–∞–∫—Ü–∏–π

–¢–µ–º–∞: ${topic}
${topicFull !== topic ? `\n${topicFull}` : ""}`;
  },
  winnerAnnouncement: (username, score, type) => {
    const labels = {
      daily: "–¥–Ω–µ–≤–Ω–æ–≥–æ",
      weekly: "–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ",
      monthly: "–º–µ—Å—è—á–Ω–æ–≥–æ",
    };
    return `üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å ${labels[type]} —á–µ–ª–ª–µ–Ω–¥–∂–∞

${username} ‚Äî ${score} —Ä–µ–∞–∫—Ü–∏–π

–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!`;
  },
  noSubmissions: "–í —ç—Ç–æ–º —á–µ–ª–ª–µ–Ω–¥–∂–µ –Ω–µ –±—ã–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.",
  leaderboardTitle: (type) => {
    const labels = {
      daily: "–¥–Ω–µ–≤–Ω—ã—Ö",
      weekly: "–Ω–µ–¥–µ–ª—å–Ω—ã—Ö",
      monthly: "–º–µ—Å—è—á–Ω—ã—Ö",
    };
    return `–¢–æ–ø-10 –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π ${labels[type]} —á–µ–ª–ª–µ–Ω–¥–∂–µ–π`;
  },
  helpMessage: (schedule) => {
    const fmt = formatSchedule(schedule);
    return `–ë–æ—Ç –¥–ª—è –Ω–µ–π—Ä–æ-–∞—Ä—Ç —á–µ–ª–ª–µ–Ω–¥–∂–µ–π

–ö–∞–∫ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å:
1. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Ç–µ–º—ã
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ç–µ–º—É —á–µ–ª–ª–µ–Ω–¥–∂–∞
3. –°—Ç–∞–≤—å—Ç–µ —Ä–µ–∞–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–º –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
4. –ü–æ–±–µ–∂–¥–∞–µ—Ç —Ä–∞–±–æ—Ç–∞ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —á–∏—Å–ª–æ–º —Ä–µ–∞–∫—Ü–∏–π

–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:
‚Ä¢ –î–Ω–µ–≤–Ω—ã–µ ‚Äî ${fmt.daily}
‚Ä¢ –ù–µ–¥–µ–ª—å–Ω—ã–µ ‚Äî ${fmt.weekly}
‚Ä¢ –ú–µ—Å—è—á–Ω—ã–µ ‚Äî ${fmt.monthly}

–†–µ–∞–∫—Ü–∏—è üåö –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è

–ö–æ–º–∞–Ω–¥—ã:
/current ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏
/stats ‚Äî –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/leaderboard ‚Äî —Ç–æ–ø –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π`;
  },
};

// ============================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================

function getConfig(env) {
  return {
    chatId: parseInt(env.CHAT_ID, 10) || 0,
    topics: {
      daily: parseInt(env.TOPIC_DAILY, 10) || 0,
      weekly: parseInt(env.TOPIC_WEEKLY, 10) || 0,
      monthly: parseInt(env.TOPIC_MONTHLY, 10) || 0,
      winners: parseInt(env.TOPIC_WINNERS, 10) || 0,
    },
    timezoneOffset: parseInt(env.TIMEZONE_OFFSET, 10) || 0,
    language: env.BOT_LANGUAGE || "ru",
  };
}

// Get config with KV overrides for topics
async function getConfigWithTopics(env, storage) {
  const base = getConfig(env);
  const kvTopics = await storage.get("settings:topics");
  if (kvTopics) {
    base.topics = {
      daily: kvTopics.daily || base.topics.daily,
      weekly: kvTopics.weekly || base.topics.weekly,
      monthly: kvTopics.monthly || base.topics.monthly,
      winners: kvTopics.winners || base.topics.winners,
    };
  }
  return base;
}

// Default schedule settings
const defaultSchedule = {
  daily: { pollHour: 5, challengeHour: 17 },
  weekly: { pollDay: 6, pollHour: 10, challengeDay: 0, challengeHour: 17 }, // Sat/Sun
  monthly: { pollDay: 28, pollHour: 10, challengeDay: 1, challengeHour: 17 },
};

// Get schedule from KV or defaults
async function getSchedule(storage) {
  const kvSchedule = await storage.get("settings:schedule");
  return {
    daily: { ...defaultSchedule.daily, ...kvSchedule?.daily },
    weekly: { ...defaultSchedule.weekly, ...kvSchedule?.weekly },
    monthly: { ...defaultSchedule.monthly, ...kvSchedule?.monthly },
  };
}

// Format schedule for display
function formatSchedule(schedule) {
  const dayNames = ["–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤—Ç–æ—Ä–Ω–∏–∫", "—Å—Ä–µ–¥–∞", "—á–µ—Ç–≤–µ—Ä–≥", "–ø—è—Ç–Ω–∏—Ü–∞", "—Å—É–±–±–æ—Ç–∞"];
  const formatHour = (h) => `${h}:00`;

  const daily = `–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ ${formatHour(schedule.daily.challengeHour)}`;
  const weekly = `${dayNames[schedule.weekly.challengeDay]} –≤ ${formatHour(schedule.weekly.challengeHour)}`;
  const monthly = `${schedule.monthly.challengeDay}-–≥–æ —á–∏—Å–ª–∞ –≤ ${formatHour(schedule.monthly.challengeHour)}`;

  return { daily, weekly, monthly };
}

// ============================================
// TELEGRAM API
// ============================================

class TelegramAPI {
  constructor(token) {
    this.token = token;
    this.baseUrl = `https://api.telegram.org/bot${token}`;
  }

  async request(method, params = {}, retries = 3) {
    let lastError;
    let rateLimitRetries = 0;
    const MAX_RATE_LIMIT_RETRIES = 3;
    const MAX_RETRY_AFTER = 30; // Max 30 seconds wait

    for (let attempt = 0; attempt < retries; attempt++) {
      try {
        const response = await fetch(`${this.baseUrl}/${method}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(params),
        });

        const data = await response.json();

        if (!data.ok) {
          const errorCode = data.error_code;
          const description = data.description || "Telegram API error";

          // Don't retry client errors (400-499 except 429)
          if (errorCode >= 400 && errorCode < 500 && errorCode !== 429) {
            console.error(`Telegram API error: ${method}`, {
              code: errorCode,
              description,
            });
            throw new Error(`[${errorCode}] ${description}`);
          }

          // Rate limited - wait and retry (with limit!)
          if (errorCode === 429) {
            rateLimitRetries++;
            if (rateLimitRetries > MAX_RATE_LIMIT_RETRIES) {
              throw new Error(`Rate limited too many times: ${description}`);
            }
            const retryAfter = Math.min(
              data.parameters?.retry_after || 1,
              MAX_RETRY_AFTER,
            );
            console.warn(
              `Rate limited (${rateLimitRetries}/${MAX_RATE_LIMIT_RETRIES}), waiting ${retryAfter}s...`,
            );
            await new Promise((r) => setTimeout(r, retryAfter * 1000));
            attempt--; // Don't count against main retries, but count against rate limit retries
            continue;
          }

          throw new Error(description);
        }

        return data.result;
      } catch (e) {
        lastError = e;
        // Don't retry non-network errors
        if (e instanceof SyntaxError || e.message?.startsWith("[4")) {
          throw e;
        }
        if (attempt < retries - 1) {
          const delay = Math.pow(2, attempt) * 1000;
          console.warn(
            `Telegram API retry ${attempt + 1}/${retries} for ${method}`,
          );
          await new Promise((r) => setTimeout(r, delay));
        }
      }
    }

    console.error(
      `Telegram API failed after ${retries} attempts: ${method}`,
      lastError,
    );
    throw lastError;
  }

  async sendMessage(chatId, text, options = {}) {
    // Truncate if too long (Telegram limit 4096)
    if (text.length > 4096) {
      console.warn(`Message too long (${text.length}), truncating`);
      text = text.substring(0, 4093) + "...";
    }
    return this.request("sendMessage", { chat_id: chatId, text, ...options });
  }

  async sendPoll(chatId, question, options, params = {}) {
    // Validate poll options (max 10, each max 100 bytes)
    if (options.length > 10) {
      console.warn(
        `Too many poll options (${options.length}), truncating to 10`,
      );
      options = options.slice(0, 10);
    }
    options = options.map((opt) => {
      if (new TextEncoder().encode(opt).length > 100) {
        let truncated = opt;
        while (new TextEncoder().encode(truncated).length > 97) {
          truncated = truncated.slice(0, -1);
        }
        return truncated + "...";
      }
      return opt;
    });

    return this.request("sendPoll", {
      chat_id: chatId,
      question: question.substring(0, 300),
      options,
      ...params,
    });
  }

  async stopPoll(chatId, messageId) {
    return this.request("stopPoll", { chat_id: chatId, message_id: messageId });
  }

  async forwardMessage(chatId, fromChatId, messageId, options = {}) {
    return this.request("forwardMessage", {
      chat_id: chatId,
      from_chat_id: fromChatId,
      message_id: messageId,
      ...options,
    });
  }

  async getChatMember(chatId, userId) {
    return this.request("getChatMember", { chat_id: chatId, user_id: userId });
  }

  async isUserAdmin(chatId, userId) {
    try {
      const member = await this.getChatMember(chatId, userId);
      return member.status === "creator" || member.status === "administrator";
    } catch {
      return false;
    }
  }

  async pinChatMessage(chatId, messageId, disableNotification = true) {
    return this.request("pinChatMessage", {
      chat_id: chatId,
      message_id: messageId,
      disable_notification: disableNotification,
    });
  }

  async unpinChatMessage(chatId, messageId) {
    return this.request("unpinChatMessage", {
      chat_id: chatId,
      message_id: messageId,
    });
  }

  async setWebhook(url, secret = null) {
    const params = {
      url,
      allowed_updates: [
        "message",
        "message_reaction",
        "message_reaction_count",
        "poll",
        "poll_answer",
      ],
    };
    if (secret) params.secret_token = secret;
    return this.request("setWebhook", params);
  }
}

// ============================================
// KV STORAGE
// ============================================

class Storage {
  constructor(kv) {
    this.kv = kv;
  }

  async get(key) {
    const data = await this.kv.get(key, "json");
    return data;
  }

  async set(key, value) {
    await this.kv.put(key, JSON.stringify(value));
  }

  async delete(key) {
    await this.kv.delete(key);
  }

  // Challenge
  async getChallenge(type) {
    return this.get(`challenge:${type}`);
  }

  async saveChallenge(challenge) {
    await this.set(`challenge:${challenge.type}`, challenge);
  }

  async getNextChallengeId(type) {
    // Use timestamp-based ID to avoid race conditions
    // Format: YYYYMMDD + random suffix
    const now = new Date();
    const datePrefix = now.getFullYear() * 10000 + (now.getMonth() + 1) * 100 + now.getDate();
    const randomSuffix = Math.floor(Math.random() * 1000);
    return datePrefix * 1000 + randomSuffix;
  }

  // Poll
  async getPoll(type) {
    return this.get(`poll:${type}`);
  }

  async savePoll(poll) {
    await this.set(`poll:${poll.type}`, poll);
  }

  async deletePoll(type) {
    await this.delete(`poll:${type}`);
  }

  // Submissions
  async getSubmissions(type, challengeId) {
    return (await this.get(`submissions:${type}:${challengeId}`)) || [];
  }

  async addSubmission(type, challengeId, submission) {
    const submissions = await this.getSubmissions(type, challengeId);
    // Check both messageId (duplicate request) and userId (one submission per user)
    if (submissions.some((s) => s.messageId === submission.messageId || s.userId === submission.userId)) {
      return false; // Already exists
    }
    submissions.push(submission);
    await this.set(`submissions:${type}:${challengeId}`, submissions);
    return true; // Successfully added
  }

  async updateSubmissionScore(type, challengeId, messageId, score) {
    const submissions = await this.getSubmissions(type, challengeId);
    const submission = submissions.find((s) => s.messageId === messageId);
    if (submission) {
      submission.score = score;
      await this.set(`submissions:${type}:${challengeId}`, submissions);
    }
  }

  // Leaderboard
  async getLeaderboard(type) {
    const map = (await this.get(`leaderboard:${type}`)) || {};
    return Object.values(map).sort((a, b) => b.wins - a.wins);
  }

  async addWin(type, userId, username) {
    const map = (await this.get(`leaderboard:${type}`)) || {};
    const key = String(userId);
    if (!map[key]) {
      map[key] = { userId, username, wins: 0 };
    }
    map[key].wins += 1;
    map[key].lastWin = Date.now();
    if (username) map[key].username = username;
    await this.set(`leaderboard:${type}`, map);
  }

  async getUserStats(type, userId) {
    const leaderboard = await this.getLeaderboard(type);
    const index = leaderboard.findIndex((e) => e.userId === userId);
    if (index === -1) return { wins: 0, rank: leaderboard.length + 1 };
    return { wins: leaderboard[index].wins, rank: index + 1 };
  }

  // Active topics
  async getActiveTopics() {
    return (await this.get("active_topics")) || {};
  }

  async setActiveTopics(topics) {
    await this.set("active_topics", topics);
  }

  async isActiveTopic(threadId) {
    const topics = await this.getActiveTopics();
    return topics[threadId] || null;
  }

  // Theme history (to avoid repetition)
  async getThemeHistory(type) {
    return (await this.get(`theme_history:${type}`)) || [];
  }

  async addThemeToHistory(type, theme) {
    const history = await this.getThemeHistory(type);
    history.unshift(theme);
    // Keep only last 10 themes
    await this.set(`theme_history:${type}`, history.slice(0, 10));
  }
}

// ============================================
// AI SERVICE (Gemini)
// ============================================

async function generateThemes(apiKey, type, language = "ru", previousThemes = [], contentMode = "vanilla") {
  // Format: "–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"
  // Short name for poll (2-3 words), full description for announcement

  const previousThemesNote = previousThemes.length > 0
    ? `- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π —ç—Ç–∏ —Ç–µ–º—ã (—É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã): ${previousThemes.join(", ")}`
    : "";

  // ========== VANILLA MODE (safe for all ages) ==========
  const vanillaPrompts = {
    daily: `<role>
–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –Ω–µ–π—Ä–æ-—Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤ (2000+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç –∞—Ä—Ç —Å –ø–æ–º–æ—â—å—é Midjourney, Stable Diffusion, DALL-E, Flux –∏ –¥—Ä—É–≥–∏—Ö AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
</role>

<task>
–ü—Ä–∏–¥—É–º–∞–π 6 —Ç–µ–º –¥–ª—è –ï–ñ–ï–î–ù–ï–í–ù–û–ì–û —á–µ–ª–ª–µ–Ω–¥–∂–∞. –≠—Ç–æ –ª—ë–≥–∫–∏–µ, –≤–µ—Å—ë–ª—ã–µ —Ç–µ–º—ã –Ω–∞ 5-15 –º–∏–Ω—É—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
</task>

<requirements>
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –î–í–£–• —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å " | ":
  1. –ö–û–†–û–¢–ö–û–ï –ù–ê–ó–í–ê–ù–ò–ï (2-3 —Å–ª–æ–≤–∞) ‚Äî –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –æ–ø—Ä–æ—Å–µ
  2. –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) ‚Äî –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
- –¢–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –Ω–∞ –í–ò–ó–£–ê–õ–¨–ù–´–ô –æ–±—Ä–∞–∑
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–π —Ç–µ–º—ã —Å –æ—Ç—Å—ã–ª–∫–∞–º–∏ –∫: —Ñ–∏–ª—å–º–∞–º, —Å–µ—Ä–∏–∞–ª–∞–º, –∞–Ω–∏–º–µ, –∏–≥—Ä–∞–º, –º–µ–º–∞–º, –ø–æ–ø-–∫—É–ª—å—Ç—É—Ä–µ
- –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ: —Ä–µ–∞–ª–∏–∑–º, —Ñ—ç–Ω—Ç–µ–∑–∏, –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è, —é–º–æ—Ä, sci-fi, –ø—Ä–∏—Ä–æ–¥–∞, –∫–∏–±–µ—Ä–ø–∞–Ω–∫, Studio Ghibli, Marvel/DC
- –¢–µ–º—ã –ù–ï –¥–æ–ª–∂–Ω—ã —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–º–ø–æ–∑–∏—Ü–∏–π
- –ò–∑–±–µ–≥–∞–π: –ø–æ–ª–∏—Ç–∏–∫–∏, —Ä–µ–ª–∏–≥–∏–∏, –Ω–∞—Å–∏–ª–∏—è, —ç—Ä–æ—Ç–∏–∫–∏
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
${previousThemesNote}
</requirements>

<format>
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û 6 —Ç–µ–º, –∫–∞–∂–¥–∞—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
</format>

<examples_for_format_only>
–≠–¢–û –ü–†–ò–ú–ï–†–´ –¢–û–õ–¨–ö–û –î–õ–Ø –ü–û–ù–ò–ú–ê–ù–ò–Ø –§–û–†–ú–ê–¢–ê –ò –°–¢–ò–õ–Ø! –ù–ï –ö–û–ü–ò–†–£–ô –ò–•!
–ü—Ä–∏–¥—É–º–∞–π 6 –ü–û–õ–ù–û–°–¢–¨–Æ –ù–û–í–´–• —Ç–µ–º, –∫–æ–º–±–∏–Ω–∏—Ä—É—è —Ä–∞–∑–Ω—ã–µ –≤—Å–µ–ª–µ–Ω–Ω—ã–µ, –∂–∞–Ω—Ä—ã –∏ –∏–¥–µ–∏.

–ö–∞—Ñ–µ –ú–∏—è–¥–∑–∞–∫–∏ | –£—é—Ç–Ω–∞—è —á–∞–π–Ω–∞—è –≤ —Å—Ç–∏–ª–µ Studio Ghibli —Å –¥—É—Ö–∞–º–∏-–ø–æ–º–æ—â–Ω–∏–∫–∞–º–∏ –∏ –∫–æ—Ç–æ–±—É—Å–æ–º –∑–∞ –æ–∫–Ω–æ–º
–î–∞—Ä—Ç –í–µ–π–¥–µ—Ä –¥–æ–º–∞ | –¢—ë–º–Ω—ã–π –ª–æ—Ä–¥ —Å–∏—Ç—Ö–æ–≤ –≤ –¥–æ–º–∞—à–Ω–µ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–µ ‚Äî –≥–æ—Ç–æ–≤–∏—Ç —É–∂–∏–Ω –∏–ª–∏ —Å–º–æ—Ç—Ä–∏—Ç —Ç–µ–ª–µ–≤–∏–∑–æ—Ä
–ü–æ–∫–µ–º–æ–Ω-–ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä | –ï—Å–ª–∏ –±—ã –≤–∞—à –ª—é–±–∏–º—ã–π –ø–æ–∫–µ–º–æ–Ω –ø—Ä–µ–ø–æ–¥–∞–≤–∞–ª –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ ‚Äî –∫–∞–∫–æ–π –ø—Ä–µ–¥–º–µ—Ç?
–®—Ä–µ–∫ –≤ –∫–æ—Å–º–æ—Å–µ | –ó–µ–ª—ë–Ω—ã–π –æ–≥—Ä –ø–æ–∫–æ—Ä—è–µ—Ç –≥–∞–ª–∞–∫—Ç–∏–∫—É –Ω–∞ —Å–≤–æ—ë–º –±–æ–ª–æ—Ç–Ω–æ–º –∫–æ—Ä–∞–±–ª–µ
–ö–æ—Ç–∏–∫ –¢–∞—Ä–∞–Ω—Ç–∏–Ω–æ | –ü—É—à–∏—Å—Ç—ã–π –∫–æ—Ç –≤ –∫—É–ª—å—Ç–æ–≤–æ–π —Å—Ü–µ–Ω–µ –∏–∑ —Ñ–∏–ª—å–º–∞ –ö–≤–µ–Ω—Ç–∏–Ω–∞ –¢–∞—Ä–∞–Ω—Ç–∏–Ω–æ
Baby Yoda –Ω–∞ —Ä–∞–±–æ—Ç–µ | –ì—Ä–æ–≥—É —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —Ç–∏–ø–∏—á–Ω—ã–º —Ä–∞–±–æ—á–∏–º –¥–Ω—ë–º –≤ –æ—Ñ–∏—Å–µ
</examples_for_format_only>`,

    weekly: `<role>
–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –Ω–µ–π—Ä–æ-—Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤ (2000+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç –∞—Ä—Ç —Å –ø–æ–º–æ—â—å—é Midjourney, Stable Diffusion, DALL-E, Flux –∏ –¥—Ä—É–≥–∏—Ö AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
</role>

<task>
–ü—Ä–∏–¥—É–º–∞–π 6 —Ç–µ–º –¥–ª—è –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–û–ì–û —á–µ–ª–ª–µ–Ω–¥–∂–∞. –≠—Ç–æ —Ç–µ–º—ã —Å—Ä–µ–¥–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, —Ç—Ä–µ–±—É—é—â–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —Å–æ —Å—Ç–∏–ª—è–º–∏ –∏ –¥–µ—Ç–∞–ª—è–º–∏.
</task>

<requirements>
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –î–í–£–• —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å " | ":
  1. –ö–û–†–û–¢–ö–û–ï –ù–ê–ó–í–ê–ù–ò–ï (2-3 —Å–ª–æ–≤–∞) ‚Äî –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –æ–ø—Ä–æ—Å–µ
  2. –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Äî –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–π –æ—Ç—Å—ã–ª–∫–∏ –∫: –∫—É–ª—å—Ç–æ–≤—ã–º —Ñ–∏–ª—å–º–∞–º, –∞–Ω–∏–º–µ, –∏–≥—Ä–∞–º, —Å–µ—Ä–∏–∞–ª–∞–º, –∫–Ω–∏–≥–∞–º
- –ú—ç—à–∞–ø—ã –∏ –∫—Ä–æ—Å—Å–æ–≤–µ—Ä—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è: —Å–º–µ—à–∏–≤–∞–π –≤—Å–µ–ª–µ–Ω–Ω—ã–µ –∏ –∂–∞–Ω—Ä—ã
- –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ: —Å—é–∂–µ—Ç–Ω—ã–µ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–µ, —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ, –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã
- –ò–∑–±–µ–≥–∞–π: –ø–æ–ª–∏—Ç–∏–∫–∏, —Ä–µ–ª–∏–≥–∏–∏, –Ω–∞—Å–∏–ª–∏—è, —ç—Ä–æ—Ç–∏–∫–∏
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
${previousThemesNote}
</requirements>

<format>
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û 6 —Ç–µ–º, –∫–∞–∂–¥–∞—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
</format>

<examples_for_format_only>
–ù–ï –ö–û–ü–ò–†–£–ô –ø—Ä–∏–º–µ—Ä—ã! –ü—Ä–∏–¥—É–º–∞–π –ù–û–í–´–ï —Ç–µ–º—ã, –∫–æ–º–±–∏–Ω–∏—Ä—É—è –¥—Ä—É–≥–∏–µ –≤—Å–µ–ª–µ–Ω–Ω—ã–µ –∏ –∂–∞–Ω—Ä—ã.

–í–µ–¥—å–º–∞–∫ –≤ –¢–æ–∫–∏–æ | –ì–µ—Ä–∞–ª—å—Ç –∏–∑ –†–∏–≤–∏–∏ —Ä–∞—Å—Å–ª–µ–¥—É–µ—Ç –¥–µ–ª–æ –æ –ø—Ä–æ–∫–ª—è—Ç–∏–∏ –≤ –Ω–µ–æ–Ω–æ–≤–æ–º –¢–æ–∫–∏–æ ‚Äî –º–µ—á–∏ –ø—Ä–æ—Ç–∏–≤ –Ω–µ–æ–Ω–∞
–í–ª–∞—Å—Ç–µ–ª–∏–Ω –î—Ä–æ–∏–¥–æ–≤ | –ß—Ç–æ –µ—Å–ª–∏ –±—ã –°–∞—É—Ä–æ–Ω —Å–æ–∑–¥–∞–≤–∞–ª –Ω–µ –∫–æ–ª—å—Ü–∞, –∞ –∞—Ä–º–∏—é –±–æ–µ–≤—ã—Ö –¥—Ä–æ–∏–¥–æ–≤ –≤ —ç—Å—Ç–µ—Ç–∏–∫–µ Star Wars
–ê–≤–∞—Ç–∞—Ä –ú–∏—è–¥–∑–∞–∫–∏ | –ú–∏—Ä –ü–∞–Ω–¥–æ—Ä—ã –≤ —Å—Ç–∏–ª–µ Studio Ghibli ‚Äî –ø—É—à–∏—Å—Ç—ã–µ –±–∞–Ω—à–∏ –∏ –î–∂–µ–π–∫ —Å—Ä–µ–¥–∏ –¥—É—Ö–æ–≤ –ª–µ—Å–∞
–û—Ñ–∏—Å –•–æ–≥–≤–∞—Ä—Ç—Å–∞ | –û–±—ã—á–Ω—ã–π open-space –æ—Ñ–∏—Å, –Ω–æ –≤—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ‚Äî –≤–æ–ª—à–µ–±–Ω–∏–∫–∏, –∞ –∫–æ—Ñ–µ –≤–∞—Ä–∏—Ç—Å—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ–º
Dark Souls —É—é—Ç–Ω—ã–π | –°–∞–º—ã–µ –º—Ä–∞—á–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–∏ Dark Souls, –Ω–æ –≤ —Ç—ë–ø–ª–æ–π —É—é—Ç–Ω–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–µ —Å –ø–ª–µ–¥–∞–º–∏ –∏ –∫–∞–∫–∞–æ
–î–∂–æ–∫–µ—Ä –Ω–∞ –ø–µ–Ω—Å–∏–∏ | –ó–ª–æ–¥–µ–∏ –∫–æ–º–∏–∫—Å–æ–≤ –Ω–∞ –∑–∞—Å–ª—É–∂–µ–Ω–Ω–æ–º –æ—Ç–¥—ã—Ö–µ ‚Äî —Å–∞–¥–æ–≤–æ–¥—Å—Ç–≤–æ, —Ä—ã–±–∞–ª–∫–∞, –≤—è–∑–∞–Ω–∏–µ
</examples_for_format_only>`,

    monthly: `<role>
–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –Ω–µ–π—Ä–æ-—Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤ (2000+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç –∞—Ä—Ç —Å –ø–æ–º–æ—â—å—é Midjourney, Stable Diffusion, DALL-E, Flux –∏ –¥—Ä—É–≥–∏—Ö AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
</role>

<task>
–ü—Ä–∏–¥—É–º–∞–π 6 —Ç–µ–º –¥–ª—è –ï–ñ–ï–ú–ï–°–Ø–ß–ù–û–ì–û —á–µ–ª–ª–µ–Ω–¥–∂–∞. –≠—Ç–æ –ê–ú–ë–ò–¶–ò–û–ó–ù–´–ï —Ç–µ–º—ã, –Ω–∞—Å—Ç–æ—è—â–∏–π –≤—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤—É.
</task>

<requirements>
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –î–í–£–• —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å " | ":
  1. –ö–û–†–û–¢–ö–û–ï –ù–ê–ó–í–ê–ù–ò–ï (2-3 —Å–ª–æ–≤–∞) ‚Äî –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –æ–ø—Ä–æ—Å–µ
  2. –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Äî –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
- –¢–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ì–õ–£–ë–û–ö–û–ô ‚Äî —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–π, –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ–π –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —Å–ª–æ–∂–Ω–æ–π
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è: –º–µ—Ç–∞—Ñ–æ—Ä—ã, –ø–∞—Ä–∞–¥–æ–∫—Å—ã, –∫—Ä–æ—Å—Å–æ–≤–µ—Ä—ã –≤—Å–µ–ª–µ–Ω–Ω—ã—Ö
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç—Å—ã–ª–∫–∏ –∫ –∫—É–ª—å—Ç–æ–≤—ã–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–ª—É–±–æ–∫–∏—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π
- –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–µ–º–∞ –¥–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
- –ò–∑–±–µ–≥–∞–π: –ø–æ–ª–∏—Ç–∏–∫–∏, —Ä–µ–ª–∏–≥–∏–∏, –Ω–∞—Å–∏–ª–∏—è, —ç—Ä–æ—Ç–∏–∫–∏
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
${previousThemesNote}
</requirements>

<format>
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û 6 —Ç–µ–º, –∫–∞–∂–¥–∞—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
</format>

<examples_for_format_only>
–ù–ï –ò–°–ü–û–õ–¨–ó–£–ô —ç—Ç–∏ –ø—Ä–∏–º–µ—Ä—ã! –°–æ–∑–¥–∞–π –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏ –∏ –∏–¥–µ—è–º–∏.

–ú–∞—Ç—Ä–∏—Ü–∞ –ø–∞–º—è—Ç–∏ | –ß—Ç–æ –µ—Å–ª–∏ –Ω–∞—à–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è ‚Äî —ç—Ç–æ –≥–ª–∏—Ç—á–∏ –≤ –ú–∞—Ç—Ä–∏—Ü–µ? –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂ –æ—Å–æ–∑–Ω–∞—ë—Ç, —á—Ç–æ –µ–≥–æ –¥–µ—Ç—Å—Ç–≤–æ ‚Äî –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞. –≠—Å—Ç–µ—Ç–∏–∫–∞ –∫–∏–±–µ—Ä–ø–∞–Ω–∫–∞ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç —Ç—ë–ø–ª—ã–µ —Å–µ–º–µ–π–Ω—ã–µ —Ñ–æ—Ç–æ.
–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–æ—Å—Å | –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å –∏–∑ –ª—é–±–æ–π –∏–≥—Ä—ã, –Ω–æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–π –∫–∞–∫ —Ç—Ä–∞–≥–∏—á–µ—Å–∫–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂. –ó–∞ –º–∏–Ω—É—Ç—É –¥–æ –±–∏—Ç–≤—ã. –ï–≥–æ –∏—Å—Ç–æ—Ä–∏—è, –µ–≥–æ –º–æ—Ç–∏–≤–∞—Ü–∏—è, –µ–≥–æ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ –Ω–∞ –≤–µ—Ä—à–∏–Ω–µ.
–ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä –ì–∏–±–ª–∏ | –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –æ–¥–∏—Å—Å–µ—è –≤ —Å—Ç–∏–ª–µ –ú–∏—è–¥–∑–∞–∫–∏. –ß—ë—Ä–Ω—ã–µ –¥—ã—Ä—ã –∫–∞–∫ –≤—Ä–∞—Ç–∞ –≤ –º–∏—Ä –¥—É—Ö–æ–≤. –ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É —è–ø–æ–Ω—Å–∫–æ–π –º–∏—Ñ–æ–ª–æ–≥–∏–∏.
–°–Ω—ã –ë—ç—Ç–º–µ–Ω–∞ | –ß—Ç–æ —Å–Ω–∏—Ç—Å—è —Ç–æ–º—É, –∫—Ç–æ –Ω–µ —Å–ø–∏—Ç? –ü–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ –ë—Ä—é—Å–∞ –£—ç–π–Ω–∞ ‚Äî —Å—é—Ä—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –º–∏—Ä, –≥–¥–µ –µ–≥–æ —Å—Ç—Ä–∞—Ö–∏ –∏ –Ω–∞–¥–µ–∂–¥—ã –æ–±—Ä–µ—Ç–∞—é—Ç —Ñ–æ—Ä–º—É.
–≠–≤–æ–ª—é—Ü–∏—è –≥–µ—Ä–æ—è | –û–¥–∏–Ω –∫—É–ª—å—Ç–æ–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂, –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –≤ 5 —Ä–∞–∑–Ω—ã—Ö —ç–ø–æ—Ö–∞—Ö –∏ —Å—Ç–∏–ª—è—Ö ‚Äî –æ—Ç –Ω–∞—Å–∫–∞–ª—å–Ω—ã—Ö —Ä–∏—Å—É–Ω–∫–æ–≤ –¥–æ –≥–æ–ª–æ–≥—Ä–∞–º–º –±—É–¥—É—â–µ–≥–æ.
–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä 2077 | –ú–∞–≥–∏—á–µ—Å–∫–∏–π –º–∏—Ä —á–µ—Ä–µ–∑ 50 –ª–µ—Ç. –í–æ–ª—à–µ–±–Ω—ã–µ –ø–∞–ª–æ—á–∫–∏ —Å USB-–ø–æ—Ä—Ç–∞–º–∏, —Å–æ–≤—ã-–¥—Ä–æ–Ω—ã, –•–æ–≥–≤–∞—Ä—Ç—Å-–º–µ—Ç–∞–≤—Å–µ–ª–µ–Ω–Ω–∞—è. –ö–∞–∫ —Ç—Ä–∞–¥–∏—Ü–∏–∏ —É–∂–∏–≤–∞—é—Ç—Å—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º?
</examples_for_format_only>`,
  };

  // ========== MEDIUM MODE (mature themes, 16+) ==========
  const mediumPrompts = {
    daily: `<role>
–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –Ω–µ–π—Ä–æ-—Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤ (2000+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤). –ê—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî –≤–∑—Ä–æ—Å–ª—ã–µ –ª—é–¥–∏ 16+.
</role>

<task>
–ü—Ä–∏–¥—É–º–∞–π 6 —Ç–µ–º –¥–ª—è –ï–ñ–ï–î–ù–ï–í–ù–û–ì–û —á–µ–ª–ª–µ–Ω–¥–∂–∞. –õ—ë–≥–∫–∏–µ —Ç–µ–º—ã –Ω–∞ 5-15 –º–∏–Ω—É—Ç, –Ω–æ –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
</task>

<requirements>
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –î–í–£–• —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å " | ":
  1. –ö–û–†–û–¢–ö–û–ï –ù–ê–ó–í–ê–ù–ò–ï (2-3 —Å–ª–æ–≤–∞) ‚Äî –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –æ–ø—Ä–æ—Å–µ
  2. –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) ‚Äî –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
- –ú–û–ñ–ù–û: –º—Ä–∞—á–Ω—ã–µ —Ç–µ–º—ã, —á—ë—Ä–Ω—ã–π —é–º–æ—Ä, –≥–æ—Ç–∏–∫–∞, —Ö–æ—Ä—Ä–æ—Ä-—ç—Å—Ç–µ—Ç–∏–∫–∞, –¥—Ä–∞–º–∞, –Ω—É–∞—Ä
- –ú–û–ñ–ù–û: —Ä–æ–º–∞–Ω—Ç–∏–∫–∞, —Å—Ç—Ä–∞—Å—Ç—å, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏ (–Ω–æ –±–µ–∑ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ—Å—Ç–∏)
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –æ—Ç—Å—ã–ª–∫–∏ –∫ –∫—É–ª—å—Ç–æ–≤—ã–º —Ñ–∏–ª—å–º–∞–º, –∏–≥—Ä–∞–º, –∞–Ω–∏–º–µ (–≤ —Ç–æ–º —á–∏—Å–ª–µ –≤–∑—Ä–æ—Å–ª—ã–º)
- –ù–ï–õ–¨–ó–Ø: —ç—Ä–æ—Ç–∏–∫–∞, –æ–±–Ω–∞–∂—ë–Ω–∫–∞, –ø–æ–ª–∏—Ç–∏–∫–∞, —Ä–µ–ª–∏–≥–∏—è
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
${previousThemesNote}
</requirements>

<format>
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û 6 —Ç–µ–º, –∫–∞–∂–¥–∞—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
</format>

<examples_for_format_only>
–ù–ï –ü–û–í–¢–û–†–Ø–ô –ø—Ä–∏–º–µ—Ä—ã! –ü—Ä–∏–¥—É–º–∞–π –°–í–û–ò —Ç–µ–º—ã –≤ –ø–æ—Ö–æ–∂–µ–º –¥—É—Ö–µ, –Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ –∏–¥–µ—è–º–∏.

Femme Fatale | –†–æ–∫–æ–≤–∞—è –∂–µ–Ω—â–∏–Ω–∞ –≤ —Å—Ç–∏–ª–µ –Ω—É–∞—Ä 40-—Ö ‚Äî —Å–∏–≥–∞—Ä–µ—Ç–Ω—ã–π –¥—ã–º, –∫—Ä–∞—Å–Ω–∞—è –ø–æ–º–∞–¥–∞, –æ–ø–∞—Å–Ω—ã–π –≤–∑–≥–ª—è–¥
–ì–∞–Ω–Ω–∏–±–∞–ª –≥–æ—Ç–æ–≤–∏—Ç | –î–æ–∫—Ç–æ—Ä –õ–µ–∫—Ç–µ—Ä –∑–∞ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ–º –∏–∑—ã—Å–∫–∞–Ω–Ω–æ–≥–æ —É–∂–∏–Ω–∞ ‚Äî —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏ —É–≥—Ä–æ–∑–∞ –≤ –∫–∞–∂–¥–æ–π –¥–µ—Ç–∞–ª–∏
–í–∞–º–ø–∏—Ä—Å–∫–∏–π –¢–∏–Ω–¥–µ—Ä | –ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–∞–π—Ç–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤ –¥–ª—è –±–µ—Å—Å–º–µ—Ä—Ç–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤ –Ω–æ—á–∏
–ü–æ—Ö–º–µ–ª—å–µ –ë–æ–≥–∞ | –ë–æ–∂–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ —ç–ø–∏—á–µ—Å–∫–æ–π –≤–µ—á–µ—Ä–∏–Ω–∫–∏ –Ω–∞ –û–ª–∏–º–ø–µ ‚Äî –¥–∞–∂–µ –≤—Å–µ–º–æ–≥—É—â–∏–µ –∏–Ω–æ–≥–¥–∞ –ø–µ—Ä–µ–±–∏—Ä–∞—é—Ç
–í–µ–¥—å–º–∞ –≤ –º–µ—Ç—Ä–æ | –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ–¥—å–º–∞ –ø–æ –¥–æ—Ä–æ–≥–µ –Ω–∞ —Ä–∞–±–æ—Ç—É ‚Äî —á—ë—Ä–Ω–∞—è –∫–æ—à–∫–∞ –≤ —Å—É–º–∫–µ, –∑–µ–ª—å–µ –≤ —Ç–µ—Ä–º–æ—Å–µ
–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–≤–∏–¥–∞–Ω–∏–µ | –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —É–∂–∏–Ω –Ω–∞ –∫—Ä—ã—à–µ –≤–æ –≤—Ä–µ–º—è –∫–æ–Ω—Ü–∞ —Å–≤–µ—Ç–∞ ‚Äî –ª—é–±–æ–≤—å —Å–∏–ª—å–Ω–µ–µ –∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–∞
</examples_for_format_only>`,

    weekly: `<role>
–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –Ω–µ–π—Ä–æ-—Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤. –ê—É–¥–∏—Ç–æ—Ä–∏—è 16+, –ª—é–±–∏—Ç –≥–ª—É–±–æ–∫–∏–µ –∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ–º—ã.
</role>

<task>
–ü—Ä–∏–¥—É–º–∞–π 6 —Ç–µ–º –¥–ª—è –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–û–ì–û —á–µ–ª–ª–µ–Ω–¥–∂–∞. –¢–µ–º—ã —Å—Ä–µ–¥–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
</task>

<requirements>
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –î–í–£–• —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å " | ":
  1. –ö–û–†–û–¢–ö–û–ï –ù–ê–ó–í–ê–ù–ò–ï (2-3 —Å–ª–æ–≤–∞) ‚Äî –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –æ–ø—Ä–æ—Å–µ
  2. –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Äî –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
- –ú–û–ñ–ù–û: –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ö–æ—Ä—Ä–æ—Ä, –º—Ä–∞—á–Ω–∞—è —ç—Å—Ç–µ—Ç–∏–∫–∞, –≥–æ—Ç–∏–∫–∞, —Ç—Ä–∏–ª–ª–µ—Ä, –¥—Ä–∞–º–∞
- –ú–û–ñ–ù–û: —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Å—Ç—Ä–∞—Å—Ç–Ω—ã–µ (–Ω–æ –Ω–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ) —Å—Ü–µ–Ω—ã, —Ä–æ–∫–æ–≤—ã–µ –∫—Ä–∞—Å–∞–≤–∏—Ü—ã/–∫—Ä–∞—Å–∞–≤—Ü—ã
- –ü–†–ò–í–ï–¢–°–¢–í–£–Æ–¢–°–Ø: –æ—Ç—Å—ã–ª–∫–∏ –∫ –∫—É–ª—å—Ç–æ–≤—ã–º R-rated —Ñ–∏–ª—å–º–∞–º, –≤–∑—Ä–æ—Å–ª—ã–º –∞–Ω–∏–º–µ, –º—Ä–∞—á–Ω—ã–º –∏–≥—Ä–∞–º
- –ù–ï–õ–¨–ó–Ø: —ç—Ä–æ—Ç–∏–∫–∞, –ø–æ–ª–∏—Ç–∏–∫–∞, —Ä–µ–ª–∏–≥–∏—è
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
${previousThemesNote}
</requirements>

<format>
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û 6 —Ç–µ–º, –∫–∞–∂–¥–∞—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
</format>

<examples_for_format_only>
–ü—Ä–∏–º–µ—Ä—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å—Ç–∏–ª—è. –°–û–ó–î–ê–ô –ù–û–í–´–ï —Ç–µ–º—ã —Å –¥—Ä—É–≥–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏ –∏ —Å—é–∂–µ—Ç–∞–º–∏!

–ë–æ–π—Ü–æ–≤—Å–∫–∏–π –∫–ª—É–± –∞—Ä—Ç | –ü–µ—Ä–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –∫–ª—É–±–∞ –Ω–µ–π—Ä–æ-—Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤ ‚Äî –Ω–∏–∫–æ–º—É –Ω–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ –∫–ª—É–±–µ. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ö–∞–æ—Å–∞ –∏ —Å–≤–æ–±–æ–¥—ã –≤ –æ–¥–Ω–æ–º –∫–∞–¥—Ä–µ.
–ì—Ä–µ—à–Ω–∏–∫–∏ —Ä–∞—è | –ï—Å–ª–∏ –±—ã —Ä–∞–π –±—ã–ª –ø–æ—Ö–æ–∂ –Ω–∞ –õ–∞—Å-–í–µ–≥–∞—Å ‚Äî –∞–Ω–≥–µ–ª—ã-–∫—Ä—É–ø—å–µ, —Å–≤—è—Ç—ã–µ —É –±–∞—Ä–Ω–æ–π —Å—Ç–æ–π–∫–∏, –Ω–µ–æ–Ω–æ–≤—ã–µ –Ω–∏–º–±—ã
–õ–µ–¥–∏-—É–±–∏–π—Ü–∞ | –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –∂–µ–Ω—â–∏–Ω–∞ –≤ –≤–µ—á–µ—Ä–Ω–µ–º –ø–ª–∞—Ç—å–µ ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –∫—Ä–æ–≤—å –Ω–∞ –µ—ë –ø–µ—Ä—á–∞—Ç–∫–∞—Ö
True Detective –≤–∞–π–± | –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–µ–∑–æ–Ω–∞ ‚Äî –∂—ë–ª—Ç—ã–π –∫–æ—Ä–æ–ª—å, –±–æ–ª–æ—Ç–∞ –õ—É–∏–∑–∏–∞–Ω—ã, —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É–∂–∞—Å
–õ—é–±–æ–≤—å –∏ —Ö–∞–æ—Å | –î–≤–æ–µ –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö –ø–æ—Å—Ä–µ–¥–∏ —Ä–∞–∑—Ä—É—à–µ–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ ‚Äî –Ω–µ–∂–Ω–æ—Å—Ç—å –≤ —ç–ø–∏—Ü–µ–Ω—Ç—Ä–µ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã
–°–∏—Ä–µ–Ω—ã —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏ | –ú–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å–∏—Ä–µ–Ω—ã –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫ XXI –≤–µ–∫—É ‚Äî –∫–∞–∫ –æ–Ω–∏ –∑–∞–º–∞–Ω–∏–≤–∞—é—Ç –∂–µ—Ä—Ç–≤ —Ç–µ–ø–µ—Ä—å?
</examples_for_format_only>`,

    monthly: `<role>
–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –Ω–µ–π—Ä–æ-—Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤. –ê—É–¥–∏—Ç–æ—Ä–∏—è 16+ —Ü–µ–Ω–∏—Ç –≥–ª—É–±–æ–∫–∏–µ, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏.
</role>

<task>
–ü—Ä–∏–¥—É–º–∞–π 6 —Ç–µ–º –¥–ª—è –ï–ñ–ï–ú–ï–°–Ø–ß–ù–û–ì–û —á–µ–ª–ª–µ–Ω–¥–∂–∞. –ê–ú–ë–ò–¶–ò–û–ó–ù–´–ï —Ç–µ–º—ã –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
</task>

<requirements>
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –î–í–£–• —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å " | ":
  1. –ö–û–†–û–¢–ö–û–ï –ù–ê–ó–í–ê–ù–ò–ï (2-3 —Å–ª–æ–≤–∞) ‚Äî –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –æ–ø—Ä–æ—Å–µ
  2. –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Äî –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
- –¢–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ì–õ–£–ë–û–ö–û–ô, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ–π, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–π
- –ú–û–ñ–ù–û: —Ç—ë–º–Ω—ã–µ —Ç–µ–º—ã, —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É–∂–∞—Å, —Å–ª–æ–∂–Ω—ã–µ —ç–º–æ—Ü–∏–∏, —Å—Ç—Ä–∞—Å—Ç—å –∏ –æ–¥–µ—Ä–∂–∏–º–æ—Å—Ç—å
- –ú–û–ñ–ù–û: –∫—Ä–∞—Å–æ—Ç–∞ –≤ —É–∂–∞—Å–Ω–æ–º, —Ä–æ–º–∞–Ω—Ç–∏–∑–∞—Ü–∏—è —Ç—å–º—ã, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≥–ª—É–±–∏–Ω—ã
- –ù–ï–õ–¨–ó–Ø: –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–∞—è —ç—Ä–æ—Ç–∏–∫–∞, –ø–æ–ª–∏—Ç–∏–∫–∞, —Ä–µ–ª–∏–≥–∏—è
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
${previousThemesNote}
</requirements>

<format>
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û 6 —Ç–µ–º, –∫–∞–∂–¥–∞—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
</format>

<examples_for_format_only>
–ù–ï –ö–û–ü–ò–†–£–ô! –≠—Ç–æ –æ–±—Ä–∞–∑—Ü—ã —Ñ–æ—Ä–º–∞—Ç–∞. –ü—Ä–∏–¥—É–º–∞–π –£–ù–ò–ö–ê–õ–¨–ù–´–ï –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏.

–°–µ–º—å —Å–º–µ—Ä—Ç–Ω—ã—Ö | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–º–µ—Ä—Ç–Ω—ã—Ö –≥—Ä–µ—Ö–æ–≤ –∫–∞–∫ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ª—é–¥–µ–π. –ì–æ—Ä–¥—ã–Ω—è –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö, –ø–æ—Ö–æ—Ç—å –≤ —Ä–µ–∫–ª–∞–º–µ, —á—Ä–µ–≤–æ—É–≥–æ–¥–∏–µ –≤ —Ñ–∞—Å—Ç—Ñ—É–¥–µ. –ö—Ç–æ –æ–Ω–∏ —Å–µ–≥–æ–¥–Ω—è –∏ –∫–∞–∫ –≤—ã–≥–ª—è–¥—è—Ç?
–ö—Ä–∞—Å–æ—Ç–∞ –º–æ–Ω—Å—Ç—Ä–∞ | –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ —É—Ä–æ–¥–ª–∏–≤—ã–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∫—Ä–∞—Å–æ—Ç—É. –≠–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—å —á—É–∂–æ–≥–æ, –≥—Ä–∞—Ü–∏—è –¥–µ–º–æ–Ω–∞, –Ω–µ–∂–Ω–æ—Å—Ç—å –æ–±–æ—Ä–æ—Ç–Ω—è –≤ –º–æ–º–µ–Ω—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏.
–¢–æ–∫—Å–∏—á–Ω–∞—è –ª—é–±–æ–≤—å | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑—Ä—É—à–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π –∫–∞–∫ –¥–≤—É—Ö —Ö–∏–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –í–º–µ—Å—Ç–µ –æ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç —è–¥, –Ω–æ –ø–æ—Ä–æ–∑–Ω—å –Ω–µ –º–æ–≥—É—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å. –ö—Ä–∞—Å–∏–≤–∞—è –æ—Ç—Ä–∞–≤–∞.
–£–∂–∏–Ω —Å –¥–µ–º–æ–Ω–∞–º–∏ | –ó–≤–∞–Ω—ã–π —É–∂–∏–Ω, –≥–¥–µ –∫–∞–∂–¥—ã–π –≥–æ—Å—Ç—å ‚Äî –ø–µ—Ä—Å–æ–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –¥–µ–º–æ–Ω–∞ —Ö–æ–∑—è–∏–Ω–∞. –¢—Ä–µ–≤–æ–≥–∞ —Ä–∞–∑–ª–∏–≤–∞–µ—Ç –≤–∏–Ω–æ, –¥–µ–ø—Ä–µ—Å—Å–∏—è —Å–∫—É—á–∞–µ—Ç –≤ —É–≥–ª—É, –≥–Ω–µ–≤ —Ä–µ–∂–µ—Ç –º—è—Å–æ.
–ü–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞—Å–∏–ª–∏—è | –ö–∞–∫ –º–µ–¥–∏–∞ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç —Ç—Ä–∞–≥–µ–¥–∏–∏ –≤ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ. –†–µ–ø–æ—Ä—Ç—ë—Ä—ã —Å –∫–∞–º–µ—Ä–∞–º–∏ –∫–∞–∫ —Å—Ç–µ—Ä–≤—è—Ç–Ω–∏–∫–∏. –í–∏–∑—É–∞–ª—å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–∞—à–µ–π –æ–¥–µ—Ä–∂–∏–º–æ—Å—Ç–∏ —á—É–∂–æ–π –±–æ–ª—å—é (–±–µ–∑ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—Å–∏–ª–∏—è).
–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–∞–Ω–µ—Ü | –î–≤–æ–µ —Ç–∞–Ω—Ü—É—é—Ç —Ç–∞–Ω–≥–æ –Ω–∞ –∫—Ä–∞—é –ø—Ä–æ–ø–∞—Å—Ç–∏. –ú–µ—Ç–∞—Ñ–æ—Ä–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π, –≥–¥–µ –∫–∞–∂–¥–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º. –°—Ç—Ä–∞—Å—Ç—å, –∫–æ–Ω—Ç—Ä–æ–ª—å, –¥–æ–≤–µ—Ä–∏–µ –∏ –ø–∞–¥–µ–Ω–∏–µ.
</examples_for_format_only>`,
  };

  // ========== NSFW MODE (artistic erotica, 21+) ==========
  const nsfwPrompts = {
    daily: `<role>
–¢—ã ‚Äî –∞—Ä—Ç-–¥–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤, —Å–æ–∑–¥–∞—é—â–∏—Ö —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é —ç—Ä–æ—Ç–∏–∫—É –∏ –ø–∏–Ω-–∞–ø –∞—Ä—Ç –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ 21+.
</role>

<task>
–ü—Ä–∏–¥—É–º–∞–π 6 —Ç–µ–º –¥–ª—è –ï–ñ–ï–î–ù–ï–í–ù–û–ì–û —á–µ–ª–ª–µ–Ω–¥–∂–∞. –õ—ë–≥–∫–∏–µ, –∏–≥—Ä–∏–≤—ã–µ —Ç–µ–º—ã –Ω–∞ –∫—Ä–∞—Å–∏–≤—É—é —ç—Ä–æ—Ç–∏–∫—É.
</task>

<requirements>
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –î–í–£–• —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å " | ":
  1. –ö–û–†–û–¢–ö–û–ï –ù–ê–ó–í–ê–ù–ò–ï (2-3 —Å–ª–æ–≤–∞) ‚Äî –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –æ–ø—Ä–æ—Å–µ
  2. –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) ‚Äî –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
- –§–æ–∫—É—Å –Ω–∞ –≠–°–¢–ï–¢–ò–ö–ï, –°–û–ë–õ–ê–ó–ù–ï –∏ –∫—Ä–∞—Å–æ—Ç–µ —Ç–µ–ª–∞
- –ú–ò–ö–°–£–ô –∫–ª–∞—Å—Å–∏–∫—É –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å: –Ω—é-–∞—Ä—Ç, pin-up, –≥–ª–∞–º—É—Ä, –±—É–¥—É–∞—Ä-—Ñ–æ—Ç–æ
- –ú–û–ñ–ù–û: —Ä–æ–ª–µ–≤—ã–µ –æ–±—Ä–∞–∑—ã (–º–µ–¥—Å–µ—Å—Ç—Ä–∞, —Å–µ–∫—Ä–µ—Ç–∞—Ä—à–∞, –≥–æ—Ä–Ω–∏—á–Ω–∞—è, —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞, —Å—Ç—é–∞—Ä–¥–µ—Å—Å–∞)
- –ú–û–ñ–ù–û: —Ñ–µ—Ç–∏—à-—ç—Å—Ç–µ—Ç–∏–∫–∞ (—á—É–ª–∫–∏, –∫–æ—Ä—Å–µ—Ç—ã, –∫—Ä—É–∂–µ–≤–Ω–æ–µ –±–µ–ª—å—ë, –ª–∞—Ç–µ–∫—Å, –∫–∞–±–ª—É–∫–∏)
- –ú–û–ñ–ù–û: —Å–æ–±–ª–∞–∑–Ω, —Ñ–ª–∏—Ä—Ç, –∏–≥—Ä–∏–≤–æ—Å—Ç—å, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏—è, —Ä–∞–∑–¥–µ–≤–∞–Ω–∏–µ
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
${previousThemesNote}
</requirements>

<format>
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û 6 —Ç–µ–º, –∫–∞–∂–¥–∞—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
</format>

<examples_for_format_only>
–ù–ï –ö–û–ü–ò–†–£–ô! –ü—Ä–∏–¥—É–º–∞–π –ù–û–í–´–ï –æ–±—Ä–∞–∑—ã –∏ —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏, —Ñ–µ—Ç–∏—à–∏, —Å—Ü–µ–Ω–∞—Ä–∏–∏.

–ú–µ–¥—Å–µ—Å—Ç—Ä–∞ –º–µ—á—Ç—ã | –°–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º–µ–¥—Å–µ—Å—Ç—Ä–∞ –≤ –∫–æ—Ä–æ—Ç–∫–æ–º —Ö–∞–ª–∞—Ç–∏–∫–µ ‚Äî –∑–∞–±–æ—Ç–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–∞ —Ç–∞–∫–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–π
Pin-up –º–µ—Ö–∞–Ω–∏–∫ | –ö—Ä–∞—Å–æ—Ç–∫–∞ –≤ –∫–æ–º–±–∏–Ω–µ–∑–æ–Ω–µ —á–∏–Ω–∏—Ç —Ä–µ—Ç—Ä–æ-–∞–≤—Ç–æ–º–æ–±–∏–ª—å ‚Äî –º–∞—Å–ª–æ –Ω–∞ –∫–æ–∂–µ, –∏–∑–≥–∏–±—ã –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º
–°–µ–∫—Ä–µ—Ç–∞—Ä—à–∞ –±–æ—Å—Å–∞ | –°—Ç—Ä–æ–≥–∞—è —Å–µ–∫—Ä–µ—Ç–∞—Ä—à–∞ –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã ‚Äî —Ä–∞—Å—Å—Ç—ë–≥–Ω—É—Ç–∞—è –±–ª—É–∑–∫–∞, —é–±–∫–∞-–∫–∞—Ä–∞–Ω–¥–∞—à, –≤–∑–≥–ª—è–¥ –ø–æ–≤–µ—Ä—Ö –æ—á–∫–æ–≤
–ß—É–ª–∫–∏ –∏ –∫–æ—Ñ–µ | –£—Ç—Ä–æ –≤ –æ–¥–Ω–∏—Ö —á—É–ª–∫–∞—Ö –∏ —Ä—É–±–∞—à–∫–µ ‚Äî –ª–µ–Ω–∏–≤–∞—è —ç—Ä–æ—Ç–∏–∫–∞ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è
–ì–æ—Ä–Ω–∏—á–Ω–∞—è –æ—Ç–µ–ª—è | –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è –≥–æ—Ä–Ω–∏—á–Ω–∞—è —Å –ø—ë—Ä—ã—à–∫–æ–≤–æ–π –º–µ—Ç—ë–ª–∫–æ–π ‚Äî –∫–ª–∞—Å—Å–∏–∫–∞ —Å–æ–±–ª–∞–∑–Ω–∞ –≤ –∫—Ä—É–∂–µ–≤–Ω–æ–º —Ñ–∞—Ä—Ç—É–∫–µ
–§–∏—Ç–Ω–µ—Å-–±–æ–≥–∏–Ω—è | –°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –∫—Ä–∞—Å–∞–≤–∏—Ü–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –∫–∞–ø–ª–∏ –ø–æ—Ç–∞, —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π —Ç–æ–ø, –∏–¥–µ–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã
</examples_for_format_only>`,

    weekly: `<role>
–¢—ã ‚Äî –∞—Ä—Ç-–¥–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤, —Å–æ–∑–¥–∞—é—â–∏—Ö —ç—Ä–æ—Ç–∏—á–µ—Å–∫–∏–π –∞—Ä—Ç –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ 21+.
</role>

<task>
–ü—Ä–∏–¥—É–º–∞–π 6 —Ç–µ–º –¥–ª—è –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–û–ì–û —á–µ–ª–ª–µ–Ω–¥–∂–∞. –¢–µ–º—ã —Å—Ä–µ–¥–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, —Å–æ—á–µ—Ç–∞—é—â–∏–µ —ç—Å—Ç–µ—Ç–∏–∫—É –∏ —Ñ–∞–Ω—Ç–∞–∑–∏—é.
</task>

<requirements>
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –î–í–£–• —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å " | ":
  1. –ö–û–†–û–¢–ö–û–ï –ù–ê–ó–í–ê–ù–ò–ï (2-3 —Å–ª–æ–≤–∞) ‚Äî –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –æ–ø—Ä–æ—Å–µ
  2. –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Äî –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
- –°–æ—á–µ—Ç–∞–π –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–Ω—Ç–∞–∑–∏–∏
- –ú–û–ñ–ù–û: —É–Ω–∏—Ñ–æ—Ä–º–∞ –∏ —Ä–æ–ª–µ–≤—ã–µ –∏–≥—Ä—ã (–º–µ–¥—Å—ë—Å—Ç—Ä—ã, —Å—Ç—é–∞—Ä–¥–µ—Å—Å—ã, –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–µ, –≥–æ—Ä–Ω–∏—á–Ω—ã–µ)
- –ú–û–ñ–ù–û: –ª—ë–≥–∫–∏–π BDSM (–±–æ–Ω–¥–∞–∂ –ª–µ–Ω—Ç–∞–º–∏, –Ω–∞—Ä—É—á–Ω–∏–∫–∏, –æ—à–µ–π–Ω–∏–∫–∏, –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –ú–û–ñ–ù–û: —Ñ–µ—Ç–∏—à-—ç—Å—Ç–µ—Ç–∏–∫–∞ (–ª–∞—Ç–µ–∫—Å, –∫–æ–∂–∞, –∫–æ—Ä—Å–µ—Ç—ã, —á—É–ª–∫–∏, –∫–∞–±–ª—É–∫–∏)
- –ú–û–ñ–ù–û: —ç—Ä–æ—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –∏–∑ –∫–∏–Ω–æ, –∞–Ω–∏–º–µ, –∏–≥—Ä
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
${previousThemesNote}
</requirements>

<format>
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û 6 —Ç–µ–º, –∫–∞–∂–¥–∞—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
</format>

<examples_for_format_only>
–û–±—Ä–∞–∑—Ü—ã —Ñ–æ—Ä–º–∞—Ç–∞ ‚Äî –°–û–ó–î–ê–ô –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï —Ç–µ–º—ã! –ö–æ–º–±–∏–Ω–∏—Ä—É–π –º–∏—Ñ–æ–ª–æ–≥–∏—é, —Ñ–µ—Ç–∏—à–∏ –∏ —Ñ–∞–Ω—Ç–∞–∑–∏–∏ –ø–æ-–Ω–æ–≤–æ–º—É.

–°–æ–Ω —Ñ–∞–≤–Ω–∞ | –ü–æ—Å–ª–µ–ø–æ–ª—É–¥–µ–Ω–Ω—ã–π –æ—Ç–¥—ã—Ö –º–∏—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –æ–±–Ω–∞–∂—ë–Ω–Ω—ã—Ö –Ω–∏–º—Ñ ‚Äî —Ç–æ–º–Ω–∞—è –Ω–µ–≥–∞ –¥—Ä–µ–≤–Ω–∏—Ö –º–∏—Ñ–æ–≤
–ü–ª–æ—Ö–∞—è —Å–µ–∫—Ä–µ—Ç–∞—Ä—à–∞ | –°–µ–∫—Ä–µ—Ç–∞—Ä—à–∞, –∫–æ—Ç–æ—Ä—É—é –∑–∞—Å—Ç–∞–ª–∏ –∑–∞ —á–µ–º-—Ç–æ –Ω–µ–ø—Ä–∏—Å—Ç–æ–π–Ω—ã–º –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –±–æ—Å—Å–∞ ‚Äî —Å–º—É—â–µ–Ω–∏–µ –∏ —Å–æ–±–ª–∞–∑–Ω
–ì–æ—Å–ø–æ–∂–∞ –∏ —Å–ª—É–≥–∞ | –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –¥–æ–º–∏–Ω–∞—Ç—Ä–∏–∫—Å –≤ –∫–æ—Ä—Å–µ—Ç–µ –∏ –µ—ë –ø–æ–∫–æ—Ä–Ω—ã–π —Å–ª—É–≥–∞ ‚Äî —ç—Å—Ç–µ—Ç–∏–∫–∞ –≤–ª–∞—Å—Ç–∏ –∏ –ø–æ–¥—á–∏–Ω–µ–Ω–∏—è
–°—Ç—é–∞—Ä–¥–µ—Å—Å—ã —Ä–µ–π—Å–∞ | –≠–∫–∏–ø–∞–∂ –Ω–æ—á–Ω–æ–≥–æ —Ä–µ–π—Å–∞ –ø–æ—Å–ª–µ –ø–æ—Å–∞–¥–∫–∏ ‚Äî —Ä–∞—Å—Å—Ç—ë–≥–Ω—É—Ç—ã–µ –±–ª—É–∑–∫–∏, —É—Å—Ç–∞–ª–æ—Å—Ç—å –∏ –∏–Ω—Ç–∏–º –≤ –æ—Ç–µ–ª–µ
–ë—É–¥—É–∞—Ä –≤–µ–¥—å–º—ã | –ö–æ–ª–¥—É–Ω—å—è –≥–æ—Ç–æ–≤–∏—Ç –∑–µ–ª—å–µ –≤ –æ–¥–Ω–æ–º –∫–æ—Ä—Å–µ—Ç–µ ‚Äî —Å–≤–µ—á–∏, –º–∞–≥–∏—è –∏ –æ–ø–∞—Å–Ω–∞—è –∫—Ä–∞—Å–æ—Ç–∞
–õ–∞—Ç–µ–∫—Å –∏ –Ω–µ–æ–Ω | –ö–∏–±–µ—Ä–ø–∞–Ω–∫-–∫—Ä–∞—Å–∞–≤–∏—Ü–∞ –≤ –ª–∞—Ç–µ–∫—Å–Ω–æ–º –∫–æ—Å—Ç—é–º–µ ‚Äî –Ω–µ–æ–Ω–æ–≤—ã–π —Å–≤–µ—Ç –Ω–∞ –±–ª–µ—Å—Ç—è—â–µ–π –∫–æ–∂–µ
</examples_for_format_only>`,

    monthly: `<role>
–¢—ã ‚Äî –∞—Ä—Ç-–¥–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤, —Å–æ–∑–¥–∞—é—â–∏—Ö –≤—ã—Å–æ–∫–æ—Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é —ç—Ä–æ—Ç–∏–∫—É –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ 21+.
</role>

<task>
–ü—Ä–∏–¥—É–º–∞–π 6 —Ç–µ–º –¥–ª—è –ï–ñ–ï–ú–ï–°–Ø–ß–ù–û–ì–û —á–µ–ª–ª–µ–Ω–¥–∂–∞. –ê–ú–ë–ò–¶–ò–û–ó–ù–´–ï —Ç–µ–º—ã, —Å–æ—á–µ—Ç–∞—é—â–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ –∏ —ç—Ä–æ—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–Ω—Ç–∞–∑–∏–∏.
</task>

<requirements>
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –î–í–£–• —á–∞—Å—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å " | ":
  1. –ö–û–†–û–¢–ö–û–ï –ù–ê–ó–í–ê–ù–ò–ï (2-3 —Å–ª–æ–≤–∞) ‚Äî –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –æ–ø—Ä–æ—Å–µ
  2. –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Äî –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
- –°–æ—á–µ—Ç–∞–π –≤—ã—Å–æ–∫–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ —ç—Ä–æ—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ–∞–Ω—Ç–∞–∑–∏—è–º–∏
- –ú–û–ñ–ù–û: –º–∏—Ñ–æ–ª–æ–≥–∏—è –∏ –∫–ª–∞—Å—Å–∏–∫–∞ (–í–µ–Ω–µ—Ä–∞, –Ω–∏–º—Ñ—ã, –º—É–∑—ã, –æ–¥–∞–ª–∏—Å–∫–∏)
- –ú–û–ñ–ù–û: —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–µ—Ç–∏—à–∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ (–æ—Ñ–∏—Å–Ω—ã–µ —Ñ–∞–Ω—Ç–∞–∑–∏–∏, —É–Ω–∏—Ñ–æ—Ä–º–∞, BDSM-—ç—Å—Ç–µ—Ç–∏–∫–∞)
- –ú–û–ñ–ù–û: —ç—Ä–æ—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –ø–æ–ø-–∫—É–ª—å—Ç—É—Ä—ã (–∞–Ω–∏–º–µ, –∫–∏–Ω–æ, –∏–≥—Ä—ã)
- –¢–µ–º—ã –¥–æ–ª–∂–Ω—ã –¥–æ–ø—É—Å–∫–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ ‚Äî –æ—Ç –Ω–µ–∂–Ω—ã—Ö –¥–æ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
${previousThemesNote}
</requirements>

<format>
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û 6 —Ç–µ–º, –∫–∞–∂–¥–∞—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
</format>

<examples_for_format_only>
–ù–ï –ü–û–í–¢–û–†–Ø–ô –ø—Ä–∏–º–µ—Ä—ã! –°–æ–∑–¥–∞–π –£–ù–ò–ö–ê–õ–¨–ù–´–ï –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ‚Äî –¥—Ä—É–≥–∏–µ —ç–ø–æ—Ö–∏, —Ñ–∞–Ω—Ç–∞–∑–∏–∏, —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã.

–û–ª–∏–º–ø –∏–Ω—Ç–∏–º–Ω—ã–π | –ë–æ–≥–∏ –î—Ä–µ–≤–Ω–µ–π –ì—Ä–µ—Ü–∏–∏ –≤ –º–æ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞—Å—Ç–∏. –ó–µ–≤—Å –∏ –µ–≥–æ –≤–æ–∑–ª—é–±–ª–µ–Ω–Ω—ã–µ, –∫—É–ø–∞–Ω–∏–µ –ê—Ñ—Ä–æ–¥–∏—Ç—ã, –æ–±—ä—è—Ç–∏—è –ê—Ä–µ—Å–∞. –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∫—Ä–∞—Å–æ—Ç–∞ –∏ –±–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.
–ë–æ–ª—å–Ω–∏—á–Ω—ã–µ —Ñ–∞–Ω—Ç–∞–∑–∏–∏ | –≠—Ä–æ—Ç–∏–∫–∞ –±–µ–ª–æ–≥–æ —Ö–∞–ª–∞—Ç–∞ –≤–æ –≤—Å–µ—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è—Ö ‚Äî –º–µ–¥—Å—ë—Å—Ç—Ä—ã –Ω–æ—á–Ω–æ–π —Å–º–µ–Ω—ã, –ø–∞—Ü–∏–µ–Ω—Ç–∫–∏ –≤ –ø–∞–ª–∞—Ç–∞—Ö, –¥–æ–∫—Ç–æ—Ä–∞ –∑–∞ –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –¥–≤–µ—Ä—è–º–∏. –°—Ç–µ—Ä–∏–ª—å–Ω–æ—Å—Ç—å –∏ —Å—Ç—Ä–∞—Å—Ç—å.
–ê–∫–∞–¥–µ–º–∏—è —Å–æ–±–ª–∞–∑–Ω–∞ | –≠—Ä–æ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –≤ —É—á–µ–±–Ω–æ–º –∑–∞–≤–µ–¥–µ–Ω–∏–∏ ‚Äî —Å—Ç—Ä–æ–≥–∏–µ —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü—ã, –¥–µ—Ä–∑–∫–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∫–∏, –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—à–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è. –ó–∞–ø—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ.
–ò—Å—Ç–æ—Ä–∏—è –û | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π BDSM-–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã. –≠–ª–µ–≥–∞–Ω—Ç–Ω–æ–µ –ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ, —à—ë–ª–∫–æ–≤—ã–µ –ª–µ–Ω—Ç—ã, –∫–æ–∂–∞–Ω—ã–µ –æ—à–µ–π–Ω–∏–∫–∏. –≠—Å—Ç–µ—Ç–∏–∫–∞ –≤–ª–∞—Å—Ç–∏ –∏ –¥–æ–≤–µ—Ä–∏—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.
–ö–∞–±–∞—Ä–µ –ú—É–ª–µ–Ω –†—É–∂ | –≠—Ä–æ—Ç–∏–∫–∞ –ü–∞—Ä–∏–∂–∞ belle √©poque ‚Äî –∫–∞–Ω–∫–∞–Ω, –ø–µ—Ä—å—è, –∫–æ—Ä—Å–µ—Ç—ã, –∫—É—Ä—Ç–∏–∑–∞–Ω–∫–∏ –≤ –±—É–¥—É–∞—Ä–∞—Ö. –î–µ–∫–∞–¥–∞–Ω—Å, —à–∞–º–ø–∞–Ω—Å–∫–æ–µ –∏ –ø—Ä–æ–¥–∞–∂–Ω–∞—è –ª—é–±–æ–≤—å –∫–∞–∫ –∏—Å–∫—É—Å—Å—Ç–≤–æ.
–ö–æ—Å–ø–ª–µ–π –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü | –≠—Ä–æ—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ—Ä—Å–∏–∏ –∫—É–ª—å—Ç–æ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π ‚Äî –∞–Ω–∏–º–µ-–¥–µ–≤—É—à–∫–∏, —Å—É–ø–µ—Ä–≥–µ—Ä–æ–∏–Ω–∏, –ø—Ä–∏–Ω—Ü–µ—Å—Å—ã Disney –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö. –î–µ—Ç—Å–∫–∏–µ —Ñ–∞–Ω—Ç–∞–∑–∏–∏ –≤—ã—Ä–æ—Å–ª–∏ –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏.
</examples_for_format_only>`,
  };

  // Select prompts based on content mode
  const allPrompts = {
    vanilla: vanillaPrompts,
    medium: mediumPrompts,
    nsfw: nsfwPrompts,
  };

  const modePrompts = allPrompts[contentMode] || vanillaPrompts;
  const prompt = modePrompts[type];

  try {
    console.log("Gemini API request starting...", { type, hasApiKey: !!apiKey, keyLength: apiKey?.length });

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-goog-api-key": apiKey,
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 1.0, maxOutputTokens: 1000 },
        }),
      },
    );

    console.log("Gemini API response status:", response.status, response.statusText);

    if (!response.ok) {
      const errorText = await response.text();
      console.error("Gemini API error response:", { status: response.status, body: errorText });
      throw new Error(`API error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    console.log("Gemini API response data:", JSON.stringify(data).substring(0, 500));

    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";

    if (!text) {
      console.error("Gemini API empty response:", {
        hasCandiates: !!data.candidates,
        candidatesLength: data.candidates?.length,
        error: data.error,
        promptFeedback: data.promptFeedback
      });
    }

    // Parse lines in format "Short | Full"
    const themes = text
      .split("\n")
      .map((l) => l.trim())
      .filter((l) => l.includes("|") && l.length > 5)
      .slice(0, 6);

    console.log("Gemini parsed themes:", themes.length);

    if (themes.length >= 6) return themes;

    console.warn("Gemini returned less than 6 themes, using fallback", { themesCount: themes.length });
  } catch (e) {
    console.error("Gemini AI error:", { message: e.message, stack: e.stack });
  }

  // Fallback themes in format "Short | Full" for each content mode
  const allFallbacks = {
    vanilla: {
      daily: [
        "–ö–∞—Ñ–µ –ú–∏—è–¥–∑–∞–∫–∏ | –£—é—Ç–Ω–∞—è —á–∞–π–Ω–∞—è –≤ —Å—Ç–∏–ª–µ Studio Ghibli, –≥–¥–µ –¥—É—Ö–∏-–ø–æ–º–æ—â–Ω–∏–∫–∏ —Ä–∞–∑–Ω–æ—Å—è—Ç —á–∞–π, –∞ –∑–∞ –æ–∫–Ω–æ–º –º–∏—Ä–Ω–æ –¥—Ä–µ–º–ª–µ—Ç –∫–æ—Ç–æ–±—É—Å",
        "–î–∞—Ä—Ç –í–µ–π–¥–µ—Ä –¥–æ–º–∞ | –¢—ë–º–Ω—ã–π –ª–æ—Ä–¥ —Å–∏—Ç—Ö–æ–≤ –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –¥–æ–º–∞—à–Ω–µ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–µ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –≥–æ—Ç–æ–≤–∏—Ç —É–∂–∏–Ω –∏–ª–∏ —Å–º–æ—Ç—Ä–∏—Ç —Å–µ—Ä–∏–∞–ª—ã",
        "–ü–æ–∫–µ–º–æ–Ω-–ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä | –í–∞—à –ª—é–±–∏–º—ã–π –ø–æ–∫–µ–º–æ–Ω –ø–æ–ª—É—á–∏–ª —É—á—ë–Ω—É—é —Å—Ç–µ–ø–µ–Ω—å –∏ —Ç–µ–ø–µ—Ä—å –ø—Ä–µ–ø–æ–¥–∞—ë—Ç –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ. –ö–∞–∫–æ–π –ø—Ä–µ–¥–º–µ—Ç –æ–Ω –≤–µ–¥—ë—Ç?",
        "–®—Ä–µ–∫ –≤ –∫–æ—Å–º–æ—Å–µ | –ó–µ–ª—ë–Ω—ã–π –æ–≥—Ä –∏ –µ–≥–æ –≤–µ—Ä–Ω—ã–π –æ—Å—ë–ª –ø–æ–∫–æ—Ä—è—é—Ç –≥–∞–ª–∞–∫—Ç–∏–∫—É –Ω–∞ –±–æ–ª–æ—Ç–Ω–æ–º –∫–æ—Å–º–∏—á–µ—Å–∫–æ–º –∫–æ—Ä–∞–±–ª–µ",
        "Baby Yoda –Ω–∞ —Ä–∞–±–æ—Ç–µ | –ú–∞–ª–µ–Ω—å–∫–∏–π –ì—Ä–æ–≥—É –≥–µ—Ä–æ–∏—á–µ—Å–∫–∏ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —Ç–∏–ø–∏—á–Ω—ã–º —Ä–∞–±–æ—á–∏–º –¥–Ω—ë–º –≤ –æ—Ñ–∏—Å–µ, –∏—Å–ø–æ–ª—å–∑—É—è –°–∏–ª—É –¥–ª—è –∫–æ—Ñ–µ-–±—Ä–µ–π–∫–æ–≤",
        "–ö–æ—Ç–∏–∫ –¢–∞—Ä–∞–Ω—Ç–∏–Ω–æ | –ü—É—à–∏—Å—Ç—ã–π –∫–æ—Ç –≤–æ—Å—Å–æ–∑–¥–∞—ë—Ç –∫—É–ª—å—Ç–æ–≤—É—é —Å—Ü–µ–Ω—É –∏–∑ —Ñ–∏–ª—å–º–∞ –ö–≤–µ–Ω—Ç–∏–Ω–∞ –¢–∞—Ä–∞–Ω—Ç–∏–Ω–æ ‚Äî –¥—Ä–∞–º–∞, —Å—Ç–∏–ª—å, —É—Å—ã",
      ],
      weekly: [
        "–í–µ–¥—å–º–∞–∫ –≤ –¢–æ–∫–∏–æ | –ì–µ—Ä–∞–ª—å—Ç –∏–∑ –†–∏–≤–∏–∏ —Ä–∞—Å—Å–ª–µ–¥—É–µ—Ç –∑–∞–≥–∞–¥–æ—á–Ω–æ–µ –ø—Ä–æ–∫–ª—è—Ç–∏–µ –≤ –Ω–µ–æ–Ω–æ–≤—ã—Ö –¥–∂—É–Ω–≥–ª—è—Ö –Ω–æ—á–Ω–æ–≥–æ –¢–æ–∫–∏–æ ‚Äî —Å–µ—Ä–µ–±—Ä—è–Ω—ã–π –º–µ—á –ø—Ä–æ—Ç–∏–≤ –Ω–µ–æ–Ω–æ–≤—ã—Ö –≤—ã–≤–µ—Å–æ–∫",
        "–í–ª–∞—Å—Ç–µ–ª–∏–Ω –î—Ä–æ–∏–¥–æ–≤ | –ß—Ç–æ –µ—Å–ª–∏ –±—ã –°–∞—É—Ä–æ–Ω –≤–º–µ—Å—Ç–æ –∫–æ–ª–µ—Ü —Å–æ–∑–¥–∞–≤–∞–ª –∞—Ä–º–∏—é –±–æ–µ–≤—ã—Ö –¥—Ä–æ–∏–¥–æ–≤? –ú–æ—Ä–¥–æ—Ä –≤—Å—Ç—Ä–µ—á–∞–µ—Ç —ç—Å—Ç–µ—Ç–∏–∫—É Star Wars",
        "–ê–≤–∞—Ç–∞—Ä –ú–∏—è–¥–∑–∞–∫–∏ | –ú–∏—Ä –ü–∞–Ω–¥–æ—Ä—ã –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –≤ —Å—Ç–∏–ª–µ Studio Ghibli ‚Äî –ø—É—à–∏—Å—Ç—ã–µ –±–∞–Ω—à–∏, –î–∂–µ–π–∫ —Å—Ä–µ–¥–∏ –ª–µ—Å–Ω—ã—Ö –¥—É—Ö–æ–≤, –º–∞–≥–∏—è –≤–º–µ—Å—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π",
        "Dark Souls —É—é—Ç–Ω—ã–π | –°–∞–º—ã–µ –º—Ä–∞—á–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–∏ Dark Souls, –Ω–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ —Ç—ë–ø–ª—ã–µ –∏ —É—é—Ç–Ω—ã–µ ‚Äî –ø–ª–µ–¥—ã –Ω–∞ –∫–æ—Å—Ç—è—Ö, –∫–∞–∫–∞–æ —É –∫–æ—Å—Ç—Ä–∞",
        "–û—Ñ–∏—Å –•–æ–≥–≤–∞—Ä—Ç—Å–∞ | –û–±—ã—á–Ω—ã–π open-space –æ—Ñ–∏—Å, –Ω–æ –≤—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ‚Äî –≤–æ–ª—à–µ–±–Ω–∏–∫–∏. –ö–æ—Ñ–µ –≤–∞—Ä–∏—Ç—Å—è Accio, –æ—Ç—á—ë—Ç—ã –ª–µ—Ç–∞—é—Ç —Å–∞–º–∏",
        "–î–∂–æ–∫–µ—Ä –Ω–∞ –ø–µ–Ω—Å–∏–∏ | –ö—É–ª—å—Ç–æ–≤—ã–µ –∑–ª–æ–¥–µ–∏ –∫–æ–º–∏–∫—Å–æ–≤ –Ω–∞ –∑–∞—Å–ª—É–∂–µ–Ω–Ω–æ–º –æ—Ç–¥—ã—Ö–µ ‚Äî —Å–∞–¥–æ–≤–æ–¥—Å—Ç–≤–æ, —Ä—ã–±–∞–ª–∫–∞, –≤—è–∑–∞–Ω–∏–µ –≤ –ê—Ä–∫—Ö–µ–º–µ",
      ],
      monthly: [
        "–ú–∞—Ç—Ä–∏—Ü–∞ –ø–∞–º—è—Ç–∏ | –ß—Ç–æ –µ—Å–ª–∏ –Ω–∞—à–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è ‚Äî —ç—Ç–æ –≥–ª–∏—Ç—á–∏ –≤ –ú–∞—Ç—Ä–∏—Ü–µ? –ú–æ–º–µ–Ω—Ç –æ—Å–æ–∑–Ω–∞–Ω–∏—è, —á—Ç–æ —Ç–≤–æ—ë –¥–µ—Ç—Å—Ç–≤–æ ‚Äî –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞. –ö–∏–±–µ—Ä–ø–∞–Ω–∫ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç —Å–µ–º–µ–π–Ω—ã–π –∞–ª—å–±–æ–º.",
        "–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–æ—Å—Å | –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å –ª—é–±–æ–π –∏–≥—Ä—ã –∑–∞ –º–∏–Ω—É—Ç—É –¥–æ –±–∏—Ç–≤—ã ‚Äî –Ω–µ –º–æ–Ω—Å—Ç—Ä, –∞ —Ç—Ä–∞–≥–∏—á–µ—Å–∫–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ —Å–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π, –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π –∏ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ–º –Ω–∞ –≤–µ—Ä—à–∏–Ω–µ",
        "–ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä –ì–∏–±–ª–∏ | –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –æ–¥–∏—Å—Å–µ—è –≤ —Å—Ç–∏–ª–µ –ú–∏—è–¥–∑–∞–∫–∏. –ß—ë—Ä–Ω—ã–µ –¥—ã—Ä—ã –∫–∞–∫ –≤—Ä–∞—Ç–∞ –≤ –º–∏—Ä –¥—É—Ö–æ–≤. –ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É —è–ø–æ–Ω—Å–∫–æ–π –º–∏—Ñ–æ–ª–æ–≥–∏–∏ –∏ —Ç—ë–ø–ª–æ–≥–æ –≤–æ–ª—à–µ–±—Å—Ç–≤–∞.",
        "–°–Ω—ã –ë—ç—Ç–º–µ–Ω–∞ | –ß—Ç–æ —Å–Ω–∏—Ç—Å—è —á–µ–ª–æ–≤–µ–∫—É, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Å–ø–∏—Ç? –ü–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ –ë—Ä—é—Å–∞ –£—ç–π–Ω–∞ ‚Äî —Å—é—Ä—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –º–∏—Ä, –≥–¥–µ –µ–≥–æ —Å—Ç—Ä–∞—Ö–∏ –∏ –Ω–∞–¥–µ–∂–¥—ã –æ–±—Ä–µ—Ç–∞—é—Ç –≤–∏–¥–∏–º—É—é —Ñ–æ—Ä–º—É",
        "–≠–≤–æ–ª—é—Ü–∏—è –≥–µ—Ä–æ—è | –û–¥–∏–Ω –∫—É–ª—å—Ç–æ–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –≤ 5 —ç–ø–æ—Ö–∞—Ö ‚Äî –æ—Ç –Ω–∞—Å–∫–∞–ª—å–Ω—ã—Ö —Ä–∏—Å—É–Ω–∫–æ–≤ –¥–æ –Ω–µ–æ–Ω–æ–≤—ã—Ö –≥–æ–ª–æ–≥—Ä–∞–º–º –±—É–¥—É—â–µ–≥–æ. –ö–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è –≥–µ—Ä–æ–π —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º?",
        "–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä 2077 | –ú–∞–≥–∏—á–µ—Å–∫–∏–π –º–∏—Ä —á–µ—Ä–µ–∑ 50 –ª–µ—Ç: –≤–æ–ª—à–µ–±–Ω—ã–µ –ø–∞–ª–æ—á–∫–∏ —Å USB, —Å–æ–≤—ã-–¥—Ä–æ–Ω—ã, –•–æ–≥–≤–∞—Ä—Ç—Å-–º–µ—Ç–∞–≤—Å–µ–ª–µ–Ω–Ω–∞—è. –¢—Ä–∞–¥–∏—Ü–∏–∏ vs –ø—Ä–æ–≥—Ä–µ—Å—Å.",
      ],
    },
    medium: {
      daily: [
        "Femme Fatale | –†–æ–∫–æ–≤–∞—è –∂–µ–Ω—â–∏–Ω–∞ –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —Å—Ç–∏–ª–µ –Ω—É–∞—Ä 40-—Ö ‚Äî —Å–∏–≥–∞—Ä–µ—Ç–Ω—ã–π –¥—ã–º, –∫—Ä–æ–≤–∞–≤–æ-–∫—Ä–∞—Å–Ω–∞—è –ø–æ–º–∞–¥–∞, –≤–∑–≥–ª—è–¥, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –±–µ–≥—É—Ç –º—É—Ä–∞—à–∫–∏",
        "–ì–∞–Ω–Ω–∏–±–∞–ª –≥–æ—Ç–æ–≤–∏—Ç | –î–æ–∫—Ç–æ—Ä –õ–µ–∫—Ç–µ—Ä –∑–∞ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ–º –∏–∑—ã—Å–∫–∞–Ω–Ω–æ–≥–æ —É–∂–∏–Ω–∞ ‚Äî —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–æ–π –∫—É—Ö–Ω–∏ –∏ –ª–µ–¥–µ–Ω—è—â–∞—è —É–≥—Ä–æ–∑–∞ –≤ –∫–∞–∂–¥–æ–π –¥–µ—Ç–∞–ª–∏",
        "–í–∞–º–ø–∏—Ä—Å–∫–∏–π –¢–∏–Ω–¥–µ—Ä | –ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–∞–π—Ç–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤ –¥–ª—è –±–µ—Å—Å–º–µ—Ä—Ç–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤ –Ω–æ—á–∏? –ò–Ω—Ç–µ—Ä–µ—Å—ã: –∫—Ä–æ–≤—å, –≥–æ—Ç–∏–∫–∞, –ª—É–Ω–Ω—ã–π —Å–≤–µ—Ç",
        "–ü–æ—Ö–º–µ–ª—å–µ –ë–æ–≥–∞ | –î—Ä–µ–≤–Ω–µ–µ –±–æ–∂–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ —ç–ø–∏—á–µ—Å–∫–æ–π –≤–µ—á–µ—Ä–∏–Ω–∫–∏ –Ω–∞ –û–ª–∏–º–ø–µ ‚Äî –¥–∞–∂–µ –≤—Å–µ–º–æ–≥—É—â–∏–µ –∏–Ω–æ–≥–¥–∞ –ø–µ—Ä–µ–±–∏—Ä–∞—é—Ç —Å –∞–º–±—Ä–æ–∑–∏–µ–π",
        "–í–µ–¥—å–º–∞ –≤ –º–µ—Ç—Ä–æ | –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ–¥—å–º–∞ –ø–æ –¥–æ—Ä–æ–≥–µ –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é —Ä–∞–±–æ—Ç—É ‚Äî —á—ë—Ä–Ω–∞—è –∫–æ—à–∫–∞ –≤ —Å—É–º–∫–µ Prada, –∑–µ–ª—å–µ –≤ —Ç–µ—Ä–º–æ—Å–µ Starbucks",
        "–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–≤–∏–¥–∞–Ω–∏–µ | –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —É–∂–∏–Ω –Ω–∞ –∫—Ä—ã—à–µ –Ω–µ–±–æ—Å–∫—Ä—ë–±–∞ –≤–æ –≤—Ä–µ–º—è –∫–æ–Ω—Ü–∞ —Å–≤–µ—Ç–∞ ‚Äî –ª—é–±–æ–≤—å —Å–∏–ª—å–Ω–µ–µ –∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–∞, —à–∞–º–ø–∞–Ω—Å–∫–æ–µ –Ω–∞ —Ñ–æ–Ω–µ –º–µ—Ç–µ–æ—Ä–∏—Ç–æ–≤",
      ],
      weekly: [
        "–ë–æ–π—Ü–æ–≤—Å–∫–∏–π –∫–ª—É–± –∞—Ä—Ç | –ü–µ—Ä–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –∫–ª—É–±–∞ –Ω–µ–π—Ä–æ-—Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤ ‚Äî –Ω–∏–∫–æ–º—É –Ω–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ –∫–ª—É–±–µ. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ö–∞–æ—Å–∞, —Å–≤–æ–±–æ–¥—ã –∏ —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è –∏–ª–ª—é–∑–∏–π –≤ –æ–¥–Ω–æ–º –∫–∞–¥—Ä–µ",
        "–ì—Ä–µ—à–Ω–∏–∫–∏ —Ä–∞—è | –ï—Å–ª–∏ –±—ã —Ä–∞–π –±—ã–ª –ø–æ—Ö–æ–∂ –Ω–∞ –õ–∞—Å-–í–µ–≥–∞—Å ‚Äî –∞–Ω–≥–µ–ª—ã-–∫—Ä—É–ø—å–µ –∑–∞ –ø–æ–∫–µ—Ä–Ω—ã–º —Å—Ç–æ–ª–æ–º, —Å–≤—è—Ç—ã–µ —É –±–∞—Ä–Ω–æ–π —Å—Ç–æ–π–∫–∏, –Ω–µ–æ–Ω–æ–≤—ã–µ –Ω–∏–º–±—ã –∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –¥–∂–µ–∫–ø–æ—Ç",
        "–õ–µ–¥–∏-—É–±–∏–π—Ü–∞ | –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –∂–µ–Ω—â–∏–Ω–∞ –≤ —Ä–æ—Å–∫–æ—à–Ω–æ–º –≤–µ—á–µ—Ä–Ω–µ–º –ø–ª–∞—Ç—å–µ –Ω–∞ —Å–≤–µ—Ç—Å–∫–æ–º –ø—Ä–∏—ë–º–µ ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –∫—Ä–æ–≤—å –Ω–∞ –µ—ë –±–∞—Ä—Ö–∞—Ç–Ω—ã—Ö –ø–µ—Ä—á–∞—Ç–∫–∞—Ö",
        "True Detective –≤–∞–π–± | –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–µ–∑–æ–Ω–∞ –≤–æ –≤—Å–µ–π –∫—Ä–∞—Å–µ ‚Äî –∂—ë–ª—Ç—ã–π –∫–æ—Ä–æ–ª—å, –±–æ–ª–æ—Ç–∞ –õ—É–∏–∑–∏–∞–Ω—ã, —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É–∂–∞—Å –∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –¥–æ—Ä–æ–≥–∞ –≤ –Ω–∏–∫—É–¥–∞",
        "–õ—é–±–æ–≤—å –∏ —Ö–∞–æ—Å | –î–≤–æ–µ –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö –ø–æ—Å—Ä–µ–¥–∏ —Ä–∞–∑—Ä—É—à–µ–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ ‚Äî –Ω–µ–∂–Ω—ã–π –ø–æ—Ü–µ–ª—É–π –≤ —ç–ø–∏—Ü–µ–Ω—Ç—Ä–µ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã, –∫—Ä–∞—Å–æ—Ç–∞ –Ω–∞ —Ä—É–∏–Ω–∞—Ö",
        "–°–∏—Ä–µ–Ω—ã —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏ | –ú–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å–∏—Ä–µ–Ω—ã –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫ XXI –≤–µ–∫—É ‚Äî –∫–∞–∫ –æ–Ω–∏ –∑–∞–º–∞–Ω–∏–≤–∞—é—Ç —Å–≤–æ–∏—Ö –∂–µ—Ä—Ç–≤ –≤ —ç–ø–æ—Ö—É —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤ –∏ —Å–æ—Ü—Å–µ—Ç–µ–π?",
      ],
      monthly: [
        "–°–µ–º—å —Å–º–µ—Ä—Ç–Ω—ã—Ö | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–º–µ—Ä—Ç–Ω—ã—Ö –≥—Ä–µ—Ö–æ–≤ –∫–∞–∫ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ª—é–¥–µ–π. –ì–æ—Ä–¥—ã–Ω—è –ª–∏—Å—Ç–∞–µ—Ç Instagram, –ø–æ—Ö–æ—Ç—å –≤ —Ä–µ–∫–ª–∞–º–µ, —á—Ä–µ–≤–æ—É–≥–æ–¥–∏–µ –≤ —Ñ–∞—Å—Ç—Ñ—É–¥–µ. –ö—Ç–æ –æ–Ω–∏ —Å–µ–≥–æ–¥–Ω—è –∏ –≥–¥–µ –æ–±–∏—Ç–∞—é—Ç?",
        "–ö—Ä–∞—Å–æ—Ç–∞ –º–æ–Ω—Å—Ç—Ä–∞ | –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ —É—Ä–æ–¥–ª–∏–≤—ã–µ —Å–æ–∑–¥–∞–Ω–∏—è, –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∫—Ä–∞—Å–æ—Ç–æ–π ‚Äî —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫—Å–µ–Ω–æ–º–æ—Ä—Ñ–∞, –≥—Ä–∞—Ü–∏—è –¥–µ–º–æ–Ω–∞, –Ω–µ–∂–Ω–æ—Å—Ç—å –æ–±–æ—Ä–æ—Ç–Ω—è –≤ –º–æ–º–µ–Ω—Ç –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏",
        "–¢–æ–∫—Å–∏—á–Ω–∞—è –ª—é–±–æ–≤—å | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑—Ä—É—à–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π –∫–∞–∫ –¥–≤—É—Ö —Ö–∏–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –í–º–µ—Å—Ç–µ –æ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç —è–¥, –Ω–æ –ø–æ—Ä–æ–∑–Ω—å –Ω–µ –º–æ–≥—É—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å. –ö—Ä–∞—Å–∏–≤–∞—è, —Å–º–µ—Ä—Ç–µ–ª—å–Ω–∞—è –æ—Ç—Ä–∞–≤–∞.",
        "–£–∂–∏–Ω —Å –¥–µ–º–æ–Ω–∞–º–∏ | –ó–≤–∞–Ω—ã–π —É–∂–∏–Ω, –≥–¥–µ –∫–∞–∂–¥—ã–π –≥–æ—Å—Ç—å ‚Äî –ø–µ—Ä—Å–æ–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –¥–µ–º–æ–Ω–∞ —Ö–æ–∑—è–∏–Ω–∞. –¢—Ä–µ–≤–æ–≥–∞ —Ä–∞–∑–ª–∏–≤–∞–µ—Ç –≤–∏–Ω–æ, –¥–µ–ø—Ä–µ—Å—Å–∏—è —Å–∫—É—á–∞–µ—Ç –≤ —É–≥–ª—É, –≥–Ω–µ–≤ —è—Ä–æ—Å—Ç–Ω–æ —Ä–µ–∂–µ—Ç –º—è—Å–æ",
        "–≠—Å—Ç–µ—Ç–∏–∫–∞ –±–æ–ª–∏ | –ö–∞–∫ –º–µ–¥–∏–∞ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç —Ç—Ä–∞–≥–µ–¥–∏–∏ –≤ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ. –†–µ–ø–æ—Ä—Ç—ë—Ä—ã —Å –∫–∞–º–µ—Ä–∞–º–∏ –∫–∞–∫ —Å—Ç–µ—Ä–≤—è—Ç–Ω–∏–∫–∏ –Ω–∞–¥ –¥–æ–±—ã—á–µ–π. –ù–∞—à–∞ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–∞—è –æ–¥–µ—Ä–∂–∏–º–æ—Å—Ç—å —á—É–∂–æ–π –±–æ–ª—å—é.",
        "–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–∞–Ω–µ—Ü | –î–≤–æ–µ —Ç–∞–Ω—Ü—É—é—Ç —Å—Ç—Ä–∞—Å—Ç–Ω–æ–µ —Ç–∞–Ω–≥–æ –Ω–∞ —Å–∞–º–æ–º –∫—Ä–∞—é –ø—Ä–æ–ø–∞—Å—Ç–∏. –ú–µ—Ç–∞—Ñ–æ—Ä–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π, –≥–¥–µ –∫–∞–∂–¥–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º. –°—Ç—Ä–∞—Å—Ç—å, –∫–æ–Ω—Ç—Ä–æ–ª—å, –ø–∞–¥–µ–Ω–∏–µ.",
      ],
    },
    nsfw: {
      daily: [
        "–ú–µ–¥—Å–µ—Å—Ç—Ä–∞ –º–µ—á—Ç—ã | –°–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º–µ–¥—Å–µ—Å—Ç—Ä–∞ –≤ –∫–æ—Ä–æ—Ç–∫–æ–º —Ö–∞–ª–∞—Ç–∏–∫–µ ‚Äî –∑–∞–±–æ—Ç–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–∞ —Ç–∞–∫–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–π –∏ –æ–ø–∞—Å–Ω–æ–π –¥–ª—è —Å–µ—Ä–¥—Ü–∞",
        "–°–µ–∫—Ä–µ—Ç–∞—Ä—à–∞ –±–æ—Å—Å–∞ | –°—Ç—Ä–æ–≥–∞—è —Å–µ–∫—Ä–µ—Ç–∞—Ä—à–∞ –ø–æ—Å–ª–µ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è ‚Äî —Ä–∞—Å—Å—Ç—ë–≥–Ω—É—Ç–∞—è –±–ª—É–∑–∫–∞, —é–±–∫–∞-–∫–∞—Ä–∞–Ω–¥–∞—à, —Ç–æ–º–Ω—ã–π –≤–∑–≥–ª—è–¥ –ø–æ–≤–µ—Ä—Ö –æ—á–∫–æ–≤",
        "–ß—É–ª–∫–∏ –∏ –∫–æ—Ñ–µ | –£—Ç—Ä–æ –≤ –æ–¥–Ω–∏—Ö —á—É–ª–∫–∞—Ö –∏ –º—É–∂—Å–∫–æ–π —Ä—É–±–∞—à–∫–µ ‚Äî –ª–µ–Ω–∏–≤–∞—è —ç—Ä–æ—Ç–∏–∫–∞ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è, —Å–æ–ª–Ω—Ü–µ –Ω–∞ –∫–æ–∂–µ",
        "–ì–æ—Ä–Ω–∏—á–Ω–∞—è –æ—Ç–µ–ª—è | –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è –≥–æ—Ä–Ω–∏—á–Ω–∞—è —Å –ø—ë—Ä—ã—à–∫–æ–≤–æ–π –º–µ—Ç—ë–ª–∫–æ–π ‚Äî –∫–ª–∞—Å—Å–∏–∫–∞ —Å–æ–±–ª–∞–∑–Ω–∞ –≤ –∫—Ä—É–∂–µ–≤–Ω–æ–º —Ñ–∞—Ä—Ç—É–∫–µ –∏ —á—É–ª–∫–∞—Ö",
        "Pin-up –º–µ—Ö–∞–Ω–∏–∫ | –ö—Ä–∞—Å–æ—Ç–∫–∞ –≤ —Ä–∞—Å—Å—Ç—ë–≥–Ω—É—Ç–æ–º –∫–æ–º–±–∏–Ω–µ–∑–æ–Ω–µ —á–∏–Ω–∏—Ç —Ä–µ—Ç—Ä–æ-–∞–≤—Ç–æ–º–æ–±–∏–ª—å ‚Äî –º–∞—Å–ª–æ –Ω–∞ –∫–æ–∂–µ, –∏–∑–≥–∏–±—ã –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º",
        "–§–∏—Ç–Ω–µ—Å-–±–æ–≥–∏–Ω—è | –°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –∫—Ä–∞—Å–∞–≤–∏—Ü–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –∫–∞–ø–ª–∏ –ø–æ—Ç–∞, —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π —Ç–æ–ø, –∏–¥–µ–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã –≤ –∑–µ—Ä–∫–∞–ª–µ –∑–∞–ª–∞",
      ],
      weekly: [
        "–ì–æ—Å–ø–æ–∂–∞ –∏ —Å–ª—É–≥–∞ | –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –¥–æ–º–∏–Ω–∞—Ç—Ä–∏–∫—Å –≤ –∫–æ—Ä—Å–µ—Ç–µ –∏ —á—É–ª–∫–∞—Ö, –µ—ë –ø–æ–∫–æ—Ä–Ω—ã–π —Å–ª—É–≥–∞ –Ω–∞ –∫–æ–ª–µ–Ω—è—Ö ‚Äî —ç—Å—Ç–µ—Ç–∏–∫–∞ –≤–ª–∞—Å—Ç–∏ –∏ –ø–æ–¥—á–∏–Ω–µ–Ω–∏—è",
        "–ü–ª–æ—Ö–∞—è —Å–µ–∫—Ä–µ—Ç–∞—Ä—à–∞ | –°–µ–∫—Ä–µ—Ç–∞—Ä—à–∞, –∑–∞—Å—Ç–∏–≥–Ω—É—Ç–∞—è –∑–∞ —á–µ–º-—Ç–æ –Ω–µ–ø—Ä–∏—Å—Ç–æ–π–Ω—ã–º –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –±–æ—Å—Å–∞ ‚Äî —Å–º—É—â–µ–Ω–∏–µ, —Å–æ–±–ª–∞–∑–Ω –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è",
        "–°—Ç—é–∞—Ä–¥–µ—Å—Å—ã —Ä–µ–π—Å–∞ | –≠–∫–∏–ø–∞–∂ –Ω–æ—á–Ω–æ–≥–æ —Ä–µ–π—Å–∞ –ø–æ—Å–ª–µ –ø–æ—Å–∞–¥–∫–∏ –≤ –æ—Ç–µ–ª–µ ‚Äî —Ä–∞—Å—Å—Ç—ë–≥–Ω—É—Ç—ã–µ –±–ª—É–∑–∫–∏, —É—Å—Ç–∞–ª–æ—Å—Ç—å –∏ –∏–Ω—Ç–∏–º–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –∫–æ–ª–ª–µ–≥–∞–º–∏",
        "–õ–∞—Ç–µ–∫—Å –∏ –Ω–µ–æ–Ω | –ö–∏–±–µ—Ä–ø–∞–Ω–∫-–∫—Ä–∞—Å–∞–≤–∏—Ü–∞ –≤ –æ–±–ª–µ–≥–∞—é—â–µ–º –ª–∞—Ç–µ–∫—Å–Ω–æ–º –∫–æ—Å—Ç—é–º–µ ‚Äî –Ω–µ–æ–Ω–æ–≤—ã–π —Å–≤–µ—Ç –∏–≥—Ä–∞–µ—Ç –Ω–∞ –±–ª–µ—Å—Ç—è—â–µ–π —á—ë—Ä–Ω–æ–π –∫–æ–∂–µ",
        "–ë—É–¥—É–∞—Ä –≤–µ–¥—å–º—ã | –ö–æ–ª–¥—É–Ω—å—è –≥–æ—Ç–æ–≤–∏—Ç –ø—Ä–∏–≤–æ—Ä–æ—Ç–Ω–æ–µ –∑–µ–ª—å–µ –≤ –æ–¥–Ω–æ–º –∫–æ—Ä—Å–µ—Ç–µ ‚Äî —Å–≤–µ—á–∏, –º–∞–≥–∏—è –∏ –æ–ø–∞—Å–Ω–∞—è –∫—Ä–∞—Å–æ—Ç–∞ –≤ –∫–∞–∂–¥–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏",
        "–£—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –ø–æ—Å–ª–µ —É—Ä–æ–∫–æ–≤ | –°—Ç—Ä–æ–≥–∞—è —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–Ω—è—Ç–∏–π ‚Äî —É–∫–∞–∑–∫–∞, –æ—á–∫–∏, —Ä–∞—Å—Å—Ç—ë–≥–Ω—É—Ç–∞—è –±–ª—É–∑–∫–∞ –∏ —á–∞—Å—Ç–Ω—ã–π —É—Ä–æ–∫",
      ],
      monthly: [
        "–ë–æ–ª—å–Ω–∏—á–Ω—ã–µ —Ñ–∞–Ω—Ç–∞–∑–∏–∏ | –≠—Ä–æ—Ç–∏–∫–∞ –±–µ–ª–æ–≥–æ —Ö–∞–ª–∞—Ç–∞ –≤–æ –≤—Å–µ—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è—Ö ‚Äî –º–µ–¥—Å—ë—Å—Ç—Ä—ã –Ω–æ—á–Ω–æ–π —Å–º–µ–Ω—ã, –ø–∞—Ü–∏–µ–Ω—Ç–∫–∏ –≤ –ø–∞–ª–∞—Ç–∞—Ö, –¥–æ–∫—Ç–æ—Ä–∞ –∑–∞ –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –¥–≤–µ—Ä—è–º–∏. –°—Ç–µ—Ä–∏–ª—å–Ω–æ—Å—Ç—å –∏ —Å—Ç—Ä–∞—Å—Ç—å.",
        "–ê–∫–∞–¥–µ–º–∏—è —Å–æ–±–ª–∞–∑–Ω–∞ | –≠—Ä–æ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –≤ —É—á–µ–±–Ω–æ–º –∑–∞–≤–µ–¥–µ–Ω–∏–∏ ‚Äî —Å—Ç—Ä–æ–≥–∏–µ —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü—ã, –¥–µ—Ä–∑–∫–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∫–∏, –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—à–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è. –ó–∞–ø—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ.",
        "–ò—Å—Ç–æ—Ä–∏—è –û | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π BDSM-–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã. –≠–ª–µ–≥–∞–Ω—Ç–Ω–æ–µ –ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ, —à—ë–ª–∫–æ–≤—ã–µ –ª–µ–Ω—Ç—ã, –∫–æ–∂–∞–Ω—ã–µ –æ—à–µ–π–Ω–∏–∫–∏. –≠—Å—Ç–µ—Ç–∏–∫–∞ –≤–ª–∞—Å—Ç–∏ –∏ –¥–æ–≤–µ—Ä–∏—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
        "–ö–∞–±–∞—Ä–µ –ú—É–ª–µ–Ω –†—É–∂ | –≠—Ä–æ—Ç–∏–∫–∞ –ü–∞—Ä–∏–∂–∞ belle √©poque ‚Äî –∫–∞–Ω–∫–∞–Ω, –ø–µ—Ä—å—è, –∫–æ—Ä—Å–µ—Ç—ã, –∫—É—Ä—Ç–∏–∑–∞–Ω–∫–∏ –≤ –±—É–¥—É–∞—Ä–∞—Ö. –î–µ–∫–∞–¥–∞–Ω—Å, —à–∞–º–ø–∞–Ω—Å–∫–æ–µ –∏ –ø—Ä–æ–¥–∞–∂–Ω–∞—è –ª—é–±–æ–≤—å –∫–∞–∫ –∏—Å–∫—É—Å—Å—Ç–≤–æ.",
        "–û–ª–∏–º–ø –∏–Ω—Ç–∏–º–Ω—ã–π | –ë–æ–≥–∏ –î—Ä–µ–≤–Ω–µ–π –ì—Ä–µ—Ü–∏–∏ –≤ –º–æ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞—Å—Ç–∏. –ó–µ–≤—Å –∏ –µ–≥–æ –≤–æ–∑–ª—é–±–ª–µ–Ω–Ω—ã–µ, –∫—É–ø–∞–Ω–∏–µ –ê—Ñ—Ä–æ–¥–∏—Ç—ã, –æ–±—ä—è—Ç–∏—è –ê—Ä–µ—Å–∞. –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∫—Ä–∞—Å–æ—Ç–∞, –±–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.",
        "–ö–æ—Å–ø–ª–µ–π –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü | –≠—Ä–æ—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ—Ä—Å–∏–∏ –∫—É–ª—å—Ç–æ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π ‚Äî –∞–Ω–∏–º–µ-–¥–µ–≤—É—à–∫–∏, —Å—É–ø–µ—Ä–≥–µ—Ä–æ–∏–Ω–∏, –ø—Ä–∏–Ω—Ü–µ—Å—Å—ã –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö. –î–µ—Ç—Å–∫–∏–µ —Ñ–∞–Ω—Ç–∞–∑–∏–∏ –≤—ã—Ä–æ—Å–ª–∏ –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏.",
      ],
    },
  };

  const fallbacks = allFallbacks[contentMode] || allFallbacks.vanilla;
  return fallbacks[type];
}

// Helper to parse theme format "Short | Full"
function parseTheme(themeStr) {
  if (!themeStr || typeof themeStr !== "string") {
    return { short: "–°–≤–æ–±–æ–¥–Ω–∞—è —Ç–µ–º–∞", full: "–°–≤–æ–±–æ–¥–Ω–∞—è —Ç–µ–º–∞" };
  }
  const parts = themeStr.split("|").map((s) => s.trim());
  return {
    short: parts[0] || themeStr,
    full: parts[1] || parts[0] || themeStr,
  };
}

// ============================================
// HANDLERS
// ============================================

async function handleMessage(update, env, config, tg, storage) {
  try {
    const message = update.message;
    if (!message) return;

    const chatId = message.chat.id;
    const text = message.text || "";
    const threadId = message.message_thread_id || 0;

    // –£–±–∏—Ä–∞–µ–º @username –∏–∑ –∫–æ–º–∞–Ω–¥—ã (–≤ –≥—Ä—É–ø–ø–∞—Ö Telegram –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ)
    const command = text.split("@")[0].split(" ")[0].toLowerCase();

    // Commands
    if (command === "/start" || command === "/help") {
      const schedule = await getSchedule(storage);
      await tg.sendMessage(chatId, ru.helpMessage(schedule), {
        message_thread_id: threadId || undefined,
      });
      return;
    }

    // ============================================
    // ADMIN COMMANDS (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –≥—Ä—É–ø–ø—ã)
    // ============================================
    const isAdmin = config.chatId && message.from?.id
      ? await tg.isUserAdmin(config.chatId, message.from.id)
      : false;

    // Get topic ID - –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    if (command === "/topic_id" && isAdmin) {
      const topicInfo = threadId
        ? `ID —Ç–µ–º—ã: ${threadId}\n\n–ö–æ–º–∞–Ω–¥—ã: /set_daily, /set_weekly, /set_monthly, /set_winners`
        : "–≠—Ç–æ –æ–±—â–∏–π —á–∞—Ç. –ù–∞–ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—É –≤–Ω—É—Ç—Ä–∏ —Ç–µ–º—ã —Ñ–æ—Ä—É–º–∞.";
      await tg.sendMessage(chatId, topicInfo, {
        message_thread_id: threadId || undefined,
      });
      return;
    }

    // Set topic commands
    if (command === "/set_daily" && isAdmin) {
      if (!threadId) {
        await tg.sendMessage(chatId, "–ù–∞–ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—É –≤–Ω—É—Ç—Ä–∏ —Ç–µ–º—ã —Ñ–æ—Ä—É–º–∞", { message_thread_id: undefined });
        return;
      }
      const kvTopics = (await storage.get("settings:topics")) || {};
      kvTopics.daily = threadId;
      await storage.set("settings:topics", kvTopics);
      await tg.sendMessage(chatId, `–¢–µ–º–∞ –¥–ª—è –¥–Ω–µ–≤–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`, {
        message_thread_id: threadId,
      });
      return;
    }

    if (command === "/set_weekly" && isAdmin) {
      if (!threadId) {
        await tg.sendMessage(chatId, "–ù–∞–ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—É –≤–Ω—É—Ç—Ä–∏ —Ç–µ–º—ã —Ñ–æ—Ä—É–º–∞", { message_thread_id: undefined });
        return;
      }
      const kvTopics = (await storage.get("settings:topics")) || {};
      kvTopics.weekly = threadId;
      await storage.set("settings:topics", kvTopics);
      await tg.sendMessage(chatId, `–¢–µ–º–∞ –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`, {
        message_thread_id: threadId,
      });
      return;
    }

    if (command === "/set_monthly" && isAdmin) {
      if (!threadId) {
        await tg.sendMessage(chatId, "–ù–∞–ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—É –≤–Ω—É—Ç—Ä–∏ —Ç–µ–º—ã —Ñ–æ—Ä—É–º–∞", { message_thread_id: undefined });
        return;
      }
      const kvTopics = (await storage.get("settings:topics")) || {};
      kvTopics.monthly = threadId;
      await storage.set("settings:topics", kvTopics);
      await tg.sendMessage(chatId, `–¢–µ–º–∞ –¥–ª—è –º–µ—Å—è—á–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`, {
        message_thread_id: threadId,
      });
      return;
    }

    if (command === "/set_winners" && isAdmin) {
      if (!threadId) {
        await tg.sendMessage(chatId, "–ù–∞–ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—É –≤–Ω—É—Ç—Ä–∏ —Ç–µ–º—ã —Ñ–æ—Ä—É–º–∞", { message_thread_id: undefined });
        return;
      }
      const kvTopics = (await storage.get("settings:topics")) || {};
      kvTopics.winners = threadId;
      await storage.set("settings:topics", kvTopics);
      await tg.sendMessage(chatId, `–¢–µ–º–∞ –¥–ª—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`, {
        message_thread_id: threadId,
      });
      return;
    }

    // Content mode configuration: /set_content_mode vanilla|medium|nsfw
    if (command === "/set_content_mode" && isAdmin) {
      const args = text.trim().split(/\s+/).slice(1);
      const mode = args[0]?.toLowerCase();

      if (!mode || !CONTENT_MODES[mode]) {
        const modesList = Object.entries(CONTENT_MODES)
          .map(([key, val]) => `‚Ä¢ ${key} ‚Äî ${val.name}: ${val.description}`)
          .join("\n");
        const currentMode = (await storage.get("settings:content_mode")) || DEFAULT_CONTENT_MODE;
        await tg.sendMessage(
          chatId,
          `–†–ï–ñ–ò–ú–´ –ö–û–ù–¢–ï–ù–¢–ê

–¢–µ–∫—É—â–∏–π: ${CONTENT_MODES[currentMode].name}

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∂–∏–º—ã:
${modesList}

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /set_content_mode <—Ä–µ–∂–∏–º>
–ü—Ä–∏–º–µ—Ä: /set_content_mode medium`,
          { message_thread_id: threadId || undefined }
        );
        return;
      }

      await storage.set("settings:content_mode", mode);
      const modeInfo = CONTENT_MODES[mode];
      await tg.sendMessage(
        chatId,
        `–†–µ–∂–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ ${modeInfo.name}\n\n${modeInfo.description}`,
        { message_thread_id: threadId || undefined }
      );
      return;
    }

    // Schedule configuration: /schedule_daily 17, /schedule_weekly 0 17 (day hour), /schedule_monthly 1 17
    const scheduleMatch = command.match(/^\/schedule_(daily|weekly|monthly)$/);
    if (scheduleMatch && isAdmin) {
      const type = scheduleMatch[1];
      const args = text.trim().split(/\s+/).slice(1).map(n => parseInt(n, 10));
      const kvSchedule = (await storage.get("settings:schedule")) || {};

      if (type === "daily") {
        const hour = args[0];
        if (isNaN(hour) || hour < 0 || hour > 23) {
          await tg.sendMessage(chatId, "–§–æ—Ä–º–∞—Ç: /schedule_daily –ß–ê–° (0-23)\n–ü—Ä–∏–º–µ—Ä: /schedule_daily 17", {
            message_thread_id: threadId || undefined,
          });
          return;
        }
        kvSchedule.daily = { ...kvSchedule.daily, challengeHour: hour };
        await storage.set("settings:schedule", kvSchedule);
        await tg.sendMessage(chatId, `–î–Ω–µ–≤–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏: ${hour}:00`, {
          message_thread_id: threadId || undefined,
        });
      } else if (type === "weekly") {
        const [day, hour] = args;
        if (isNaN(day) || day < 0 || day > 6 || isNaN(hour) || hour < 0 || hour > 23) {
          await tg.sendMessage(chatId, "–§–æ—Ä–º–∞—Ç: /schedule_weekly –î–ï–ù–¨ –ß–ê–°\n–î–µ–Ω—å: 0=–≤—Å, 1=–ø–Ω, ..., 6=—Å–±\n–ü—Ä–∏–º–µ—Ä: /schedule_weekly 0 17", {
            message_thread_id: threadId || undefined,
          });
          return;
        }
        kvSchedule.weekly = { ...kvSchedule.weekly, challengeDay: day, challengeHour: hour };
        await storage.set("settings:schedule", kvSchedule);
        const dayNames = ["–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤—Ç–æ—Ä–Ω–∏–∫", "—Å—Ä–µ–¥–∞", "—á–µ—Ç–≤–µ—Ä–≥", "–ø—è—Ç–Ω–∏—Ü–∞", "—Å—É–±–±–æ—Ç–∞"];
        await tg.sendMessage(chatId, `–ù–µ–¥–µ–ª—å–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏: ${dayNames[day]} ${hour}:00`, {
          message_thread_id: threadId || undefined,
        });
      } else if (type === "monthly") {
        const [day, hour] = args;
        if (isNaN(day) || day < 1 || day > 28 || isNaN(hour) || hour < 0 || hour > 23) {
          await tg.sendMessage(chatId, "–§–æ—Ä–º–∞—Ç: /schedule_monthly –î–ï–ù–¨ –ß–ê–°\n–î–µ–Ω—å: 1-28\n–ü—Ä–∏–º–µ—Ä: /schedule_monthly 1 17", {
            message_thread_id: threadId || undefined,
          });
          return;
        }
        kvSchedule.monthly = { ...kvSchedule.monthly, challengeDay: day, challengeHour: hour };
        await storage.set("settings:schedule", kvSchedule);
        await tg.sendMessage(chatId, `–ú–µ—Å—è—á–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏: ${day}-–≥–æ —á–∏—Å–ª–∞ –≤ ${hour}:00`, {
          message_thread_id: threadId || undefined,
        });
      }
      return;
    }

    if (command === "/admin" && isAdmin) {
      const schedule = await getSchedule(storage);
      const fmt = formatSchedule(schedule);
      const currentMode = (await storage.get("settings:content_mode")) || DEFAULT_CONTENT_MODE;
      const modeInfo = CONTENT_MODES[currentMode];
      await tg.sendMessage(
        chatId,
        `–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨

–û–ø—Ä–æ—Å—ã
/poll_daily ‚Äî —Å–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å –¥–Ω—è
/poll_weekly ‚Äî —Å–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å –Ω–µ–¥–µ–ª–∏
/poll_monthly ‚Äî —Å–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å –º–µ—Å—è—Ü–∞

–ó–∞–ø—É—Å–∫
/run_daily ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π
/run_weekly ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ–¥–µ–ª—å–Ω—ã–π
/run_monthly ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–µ—Å—è—á–Ω—ã–π

–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
/finish_daily ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π
/finish_weekly ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å –Ω–µ–¥–µ–ª—å–Ω—ã–π
/finish_monthly ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å –º–µ—Å—è—á–Ω—ã–π

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/status ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
/cs_daily, /cs_weekly, /cs_monthly
/test_ai ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Gemini API

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º
/set_daily, /set_weekly, /set_monthly, /set_winners

–†–µ–∂–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ${modeInfo.name}
/set_content_mode ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º

–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (—Ç–µ–∫—É—â–µ–µ)
‚Ä¢ –î–Ω–µ–≤–Ω—ã–µ: ${fmt.daily}
‚Ä¢ –ù–µ–¥–µ–ª—å–Ω—ã–µ: ${fmt.weekly}
‚Ä¢ –ú–µ—Å—è—á–Ω—ã–µ: ${fmt.monthly}

/schedule_daily –ß–ê–°
/schedule_weekly –î–ï–ù–¨ –ß–ê–°
/schedule_monthly –î–ï–ù–¨ –ß–ê–°`,
        { message_thread_id: threadId || undefined }
      );
      return;
    }

    // Admin: Create polls (no confirmation message - poll itself is visible)
    if (command === "/poll_daily" && isAdmin) {
      await storage.deletePoll("daily");
      await generatePoll(env, config, tg, storage, "daily");
      return;
    }
    if (command === "/poll_weekly" && isAdmin) {
      await storage.deletePoll("weekly");
      await generatePoll(env, config, tg, storage, "weekly");
      return;
    }
    if (command === "/poll_monthly" && isAdmin) {
      await storage.deletePoll("monthly");
      await generatePoll(env, config, tg, storage, "monthly");
      return;
    }

    // Admin: Start challenges (announcement is pinned, no extra notification needed)
    if (command === "/run_daily" && isAdmin) {
      await startChallenge(env, config, tg, storage, "daily");
      return;
    }
    if (command === "/run_weekly" && isAdmin) {
      await startChallenge(env, config, tg, storage, "weekly");
      return;
    }
    if (command === "/run_monthly" && isAdmin) {
      await startChallenge(env, config, tg, storage, "monthly");
      return;
    }

    // Admin: Finish challenges (winner announcement is posted, no extra notification needed)
    if (command === "/finish_daily" && isAdmin) {
      await finishChallenge(env, config, tg, storage, "daily");
      return;
    }
    if (command === "/finish_weekly" && isAdmin) {
      await finishChallenge(env, config, tg, storage, "weekly");
      return;
    }
    if (command === "/finish_monthly" && isAdmin) {
      await finishChallenge(env, config, tg, storage, "monthly");
      return;
    }

    // Admin: Status
    if (command === "/status" && isAdmin) {
      const [daily, weekly, monthly, pollDaily, pollWeekly, pollMonthly] = await Promise.all([
        storage.getChallenge("daily"),
        storage.getChallenge("weekly"),
        storage.getChallenge("monthly"),
        storage.getPoll("daily"),
        storage.getPoll("weekly"),
        storage.getPoll("monthly"),
      ]);

      const formatChallenge = (c, name) => {
        if (!c) return `${name}: –Ω–µ—Ç`;
        if (c.status !== "active") return `${name}: –∑–∞–≤–µ—Ä—à—ë–Ω`;
        const endDateStr = new Date(c.endsAt).toLocaleString("ru-RU", { day: "numeric", month: "short" });
        return `${name}: –¥–æ ${endDateStr}\n   ${c.topic}`;
      };

      const statusMsg = `–°–¢–ê–¢–£–°

–û–ø—Ä–æ—Å—ã
–î–Ω–µ–≤–Ω–æ–π: ${pollDaily ? "–µ—Å—Ç—å" : "–Ω–µ—Ç"}
–ù–µ–¥–µ–ª—å–Ω—ã–π: ${pollWeekly ? "–µ—Å—Ç—å" : "–Ω–µ—Ç"}
–ú–µ—Å—è—á–Ω—ã–π: ${pollMonthly ? "–µ—Å—Ç—å" : "–Ω–µ—Ç"}

–ß–µ–ª–ª–µ–Ω–¥–∂–∏
${formatChallenge(daily, "–î–Ω–µ–≤–Ω–æ–π")}
${formatChallenge(weekly, "–ù–µ–¥–µ–ª—å–Ω—ã–π")}
${formatChallenge(monthly, "–ú–µ—Å—è—á–Ω—ã–π")}`;

      await tg.sendMessage(chatId, statusMsg, { message_thread_id: threadId || undefined });
      return;
    }

    // Admin: Current challenge stats - /cs_daily, /cs_weekly, /cs_monthly
    const csMatch = command.match(/^\/cs_(daily|weekly|monthly)$/);
    if (csMatch && isAdmin) {
      const type = csMatch[1];
      const challenge = await storage.getChallenge(type);
      const typeNames = { daily: "–î–Ω–µ–≤–Ω–æ–π", weekly: "–ù–µ–¥–µ–ª—å–Ω—ã–π", monthly: "–ú–µ—Å—è—á–Ω—ã–π" };

      if (!challenge || challenge.status !== "active") {
        await tg.sendMessage(chatId, `${typeNames[type]} —á–µ–ª–ª–µ–Ω–¥–∂\n\n–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ`, {
          message_thread_id: threadId || undefined,
        });
        return;
      }

      const submissions = await storage.getSubmissions(type, challenge.id);
      const endDateStr = new Date(challenge.endsAt).toLocaleString("ru-RU", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" });

      if (submissions.length === 0) {
        await tg.sendMessage(chatId, `${typeNames[type]} —á–µ–ª–ª–µ–Ω–¥–∂\n\n–¢–µ–º–∞: ${challenge.topic}\n–î–æ: ${endDateStr}\n\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞–±–æ—Ç`, {
          message_thread_id: threadId || undefined,
        });
        return;
      }

      // Sort by score descending, then by timestamp ascending (earlier submission wins tie)
      const sorted = [...submissions].sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return (a.timestamp || 0) - (b.timestamp || 0);
      });
      const list = sorted.map((s, i) =>
        `${i + 1}. @${s.username || s.userId} ‚Äî ${s.score}`
      ).join("\n");

      await tg.sendMessage(chatId, `${typeNames[type]} —á–µ–ª–ª–µ–Ω–¥–∂\n\n–¢–µ–º–∞: ${challenge.topic}\n–î–æ: ${endDateStr}\n–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${submissions.length}\n\n${list}`, {
        message_thread_id: threadId || undefined,
      });
      return;
    }

    // Admin: Test Gemini API
    if (command === "/test_ai" && isAdmin) {
      await tg.sendMessage(chatId, "–¢–µ—Å—Ç–∏—Ä—É—é Gemini API...", { message_thread_id: threadId || undefined });
      try {
        // Direct API call to see raw response
        const testPrompt = "–ü—Ä–∏–¥—É–º–∞–π 3 —Ç–µ–º—ã –¥–ª—è –∞—Ä—Ç-—á–µ–ª–ª–µ–Ω–¥–∂–∞. –§–æ—Ä–º–∞—Ç: –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ";
        const apiKey = env.GEMINI_API_KEY;

        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-goog-api-key": apiKey,
            },
            body: JSON.stringify({
              contents: [{ parts: [{ text: testPrompt }] }],
              generationConfig: { temperature: 1.0, maxOutputTokens: 300 },
            }),
          },
        );

        const status = response.status;
        const data = await response.json();

        let msg = `Gemini API (${status})\n\n`;

        if (data.error) {
          msg += `–û—à–∏–±–∫–∞: ${data.error.message || JSON.stringify(data.error)}`;
        } else if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
          const text = data.candidates[0].content.parts[0].text;
          msg += text.substring(0, 500);
        } else {
          msg += `–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç: ${JSON.stringify(data).substring(0, 400)}`;
        }

        await tg.sendMessage(chatId, msg, { message_thread_id: threadId || undefined });
      } catch (e) {
        await tg.sendMessage(chatId, `–û—à–∏–±–∫–∞: ${e.message}`, { message_thread_id: threadId || undefined });
      }
      return;
    }

    if (text.startsWith("/stats")) {
      const userId = message.from?.id;
      if (!userId) return;

      // Parallel KV reads for better performance
      const [daily, weekly, monthly] = await Promise.all([
        storage.getUserStats("daily", userId),
        storage.getUserStats("weekly", userId),
        storage.getUserStats("monthly", userId),
      ]);
      const total = daily.wins + weekly.wins + monthly.wins;

      const winsWord = pluralize(total, "–ø–æ–±–µ–¥–∞", "–ø–æ–±–µ–¥—ã", "–ø–æ–±–µ–¥");
      await tg.sendMessage(
        chatId,
        `–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n–í—Å–µ–≥–æ ${winsWord}: ${total}\n\n–î–Ω–µ–≤–Ω—ã–µ: ${daily.wins} (#${daily.rank})\n–ù–µ–¥–µ–ª—å–Ω—ã–µ: ${weekly.wins} (#${weekly.rank})\n–ú–µ—Å—è—á–Ω—ã–µ: ${monthly.wins} (#${monthly.rank})`,
        { message_thread_id: threadId || undefined },
      );
      return;
    }

    if (text.startsWith("/leaderboard")) {
      // Parse type: /leaderboard weekly, /leaderboard monthly, etc.
      const args = text.trim().split(/\s+/);
      const typeMap = {
        daily: "daily",
        weekly: "weekly",
        monthly: "monthly",
        –¥–Ω–µ–≤–Ω–æ–π: "daily",
        –Ω–µ–¥–µ–ª—å–Ω—ã–π: "weekly",
        –º–µ—Å—è—á–Ω—ã–π: "monthly",
        –¥–µ–Ω—å: "daily",
        –Ω–µ–¥–µ–ª—è: "weekly",
        –º–µ—Å—è—Ü: "monthly",
      };
      const type = typeMap[args[1]?.toLowerCase()] || "daily";

      const leaderboard = await storage.getLeaderboard(type);
      if (leaderboard.length === 0) {
        await tg.sendMessage(
          chatId,
          `–†–µ–π—Ç–∏–Ω–≥ ${ru.challengeTypes[type]} –ø–æ–∫–∞ –ø—É—Å—Ç`,
          { message_thread_id: threadId || undefined },
        );
        return;
      }

      const medals = ["1.", "2.", "3."];
      let msg = ru.leaderboardTitle(type) + `\n\n`;
      leaderboard.slice(0, 10).forEach((e, i) => {
        const medal = medals[i] || `${i + 1}.`;
        msg += `${medal} ${e.username || `User ${e.userId}`} ‚Äî ${e.wins} –ø–æ–±–µ–¥\n`;
      });

      // Show user's position if not in top 10
      const userId = message.from?.id;
      if (userId) {
        const userIndex = leaderboard.findIndex((e) => e.userId === userId);
        if (userIndex >= 10) {
          msg += `\n–í–∞—à–µ –º–µ—Å—Ç–æ: #${userIndex + 1}`;
        }
      }

      await tg.sendMessage(chatId, msg, {
        message_thread_id: threadId || undefined,
      });
      return;
    }

    if (text.startsWith("/current")) {
      // Parallel KV reads for better performance
      const [daily, weekly, monthly] = await Promise.all([
        storage.getChallenge("daily"),
        storage.getChallenge("weekly"),
        storage.getChallenge("monthly"),
      ]);

      const format = (c, type) => {
        if (!c || c.status !== "active")
          return `${ru.challengeTypes[type]}: –Ω–µ—Ç`;
        const endDateStr = new Date(c.endsAt).toLocaleString("ru-RU", { day: "numeric", month: "short" });
        return `${ru.challengeTypes[type]} (–¥–æ ${endDateStr})\n${c.topic}`;
      };

      await tg.sendMessage(
        chatId,
        `–ê–∫—Ç–∏–≤–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏\n\n${format(daily, "daily")}\n\n${format(weekly, "weekly")}\n\n${format(monthly, "monthly")}`,
        { message_thread_id: threadId || undefined },
      );
      return;
    }

    // Photo submission
    if (
      (message.photo && message.photo.length > 0) ||
      message.document?.mime_type?.startsWith("image/")
    ) {
      if (chatId !== config.chatId) return;

      const challengeType = await storage.isActiveTopic(threadId);
      if (!challengeType) {
        // Not a challenge topic - silently ignore
        return;
      }

      const challenge = await storage.getChallenge(challengeType);
      if (!challenge || challenge.status !== "active") {
        await tg.sendMessage(
          chatId,
          "–°–µ–π—á–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞ –≤ —ç—Ç–æ–π —Ç–µ–º–µ",
          {
            message_thread_id: threadId || undefined,
            reply_to_message_id: message.message_id,
          },
        );
        return;
      }

      if (Date.now() > challenge.endsAt) {
        await tg.sendMessage(
          chatId,
          "–í—Ä–µ–º—è —á–µ–ª–ª–µ–Ω–¥–∂–∞ –∏—Å—Ç–µ–∫–ª–æ",
          {
            message_thread_id: threadId || undefined,
            reply_to_message_id: message.message_id,
          },
        );
        return;
      }

      // Check for forwarded messages (anti-plagiarism)
      if (message.forward_origin || message.forward_from || message.forward_date) {
        console.log(`Rejected forwarded submission: user=${message.from?.id}`);
        return; // Silently reject
      }

      // Check for duplicate
      const submissions = await storage.getSubmissions(
        challengeType,
        challenge.id,
      );
      if (submissions.some((s) => s.userId === message.from?.id)) {
        await tg.sendMessage(
          chatId,
          "–í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Ä–∞–±–æ—Ç—É –≤ —ç—Ç–æ—Ç —á–µ–ª–ª–µ–Ω–¥–∂",
          {
            message_thread_id: threadId || undefined,
            reply_to_message_id: message.message_id,
          },
        );
        return;
      }

      await storage.addSubmission(challengeType, challenge.id, {
        messageId: message.message_id,
        userId: message.from?.id,
        username: message.from?.username || message.from?.first_name,
        score: 0,
        timestamp: Date.now(),
      });

      // Confirmation message
      await tg.sendMessage(chatId, "–†–∞–±–æ—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞", {
        message_thread_id: threadId || undefined,
        reply_to_message_id: message.message_id,
      });

      console.log(
        `Submission: user=${message.from?.id}, msg=${message.message_id}`,
      );
    }
  } catch (e) {
    console.error("handleMessage error:", { error: e.message, stack: e.stack });
  }
}

async function handleReactionCount(update, env, config, storage) {
  try {
    const reaction = update.message_reaction_count;
    if (!reaction) return;
    if (reaction.chat.id !== config.chatId) return;

    // Use thread ID to determine which challenge type this belongs to
    const threadId = reaction.message_thread_id;
    const challengeType = await storage.isActiveTopic(threadId);
    if (!challengeType) return;

    const challenge = await storage.getChallenge(challengeType);
    if (!challenge || challenge.status !== "active" || Date.now() >= challenge.endsAt) return;

    // Check if this message is actually a submission (avoid updating non-submissions)
    const submissions = await storage.getSubmissions(challengeType, challenge.id);
    const submission = submissions.find((s) => s.messageId === reaction.message_id);
    if (!submission) return; // Not a submission - ignore

    // Calculate score
    let score = 0;
    for (const r of reaction.reactions) {
      if (r.type.type === "emoji" && r.type.emoji !== EXCLUDED_EMOJI) {
        score += r.total_count;
      } else if (r.type.type === "custom_emoji" || r.type.type === "paid") {
        score += r.total_count;
      }
    }

    await storage.updateSubmissionScore(
      challengeType,
      challenge.id,
      reaction.message_id,
      score,
    );
  } catch (e) {
    console.error("handleReactionCount error:", {
      error: e.message,
      stack: e.stack,
    });
  }
}

// Handle individual reaction updates (when reaction authors are visible)
async function handleReaction(update, env, config, storage) {
  try {
    const reaction = update.message_reaction;
    if (!reaction) return;

    console.log("Reaction received:", JSON.stringify({
      chat_id: reaction.chat.id,
      message_id: reaction.message_id,
      thread_id: reaction.message_thread_id,
      user_id: reaction.user?.id,
      new_reaction: reaction.new_reaction,
      old_reaction: reaction.old_reaction,
    }));

    if (reaction.chat.id !== config.chatId) {
      console.log("Reaction ignored: wrong chat", { got: reaction.chat.id, expected: config.chatId });
      return;
    }

    // Find which challenge this message belongs to by checking all active challenges
    let challengeType = null;
    let challenge = null;

    for (const type of ["daily", "weekly", "monthly"]) {
      const ch = await storage.getChallenge(type);
      if (ch?.status === "active" && Date.now() < ch.endsAt) {
        // Check if this message is a submission in this challenge
        const submissions = await storage.getSubmissions(type, ch.id);
        const found = submissions.find(s => s.messageId === reaction.message_id);
        if (found) {
          challengeType = type;
          challenge = ch;
          break;
        }
      }
    }

    if (!challengeType || !challenge) {
      console.log("Reaction ignored: message not found in any active challenge", { messageId: reaction.message_id });
      return;
    }

    // Count valid reactions in new_reaction
    let userScore = 0;
    for (const r of reaction.new_reaction || []) {
      if (r.type === "emoji" && r.emoji !== EXCLUDED_EMOJI) {
        userScore += 1;
      } else if (r.type === "custom_emoji" || r.type === "paid") {
        userScore += 1;
      }
    }

    // Store this user's reaction count for this message
    const userId = reaction.user?.id;
    if (!userId) return;

    const reactionsKey = `reactions:${challengeType}:${challenge.id}:${reaction.message_id}`;
    const reactionsMap = (await storage.get(reactionsKey)) || {};
    reactionsMap[userId] = userScore;
    await storage.set(reactionsKey, reactionsMap);

    // Calculate total score from all users
    const totalScore = Object.values(reactionsMap).reduce((sum, s) => sum + s, 0);

    await storage.updateSubmissionScore(
      challengeType,
      challenge.id,
      reaction.message_id,
      totalScore,
    );

    console.log(`Reaction scored: type=${challengeType}, msg=${reaction.message_id}, user=${userId}, userScore=${userScore}, totalScore=${totalScore}`);
  } catch (e) {
    console.error("handleReaction error:", {
      error: e.message,
      stack: e.stack,
    });
  }
}

// ============================================
// CRON JOBS
// ============================================

async function generatePoll(env, config, tg, storage, type) {
  try {
    const existing = await storage.getPoll(type);
    if (existing) return;

    const topicId = config.topics[type];
    const previousThemes = await storage.getThemeHistory(type);
    const contentMode = (await storage.get("settings:content_mode")) || DEFAULT_CONTENT_MODE;
    const themesRaw = await generateThemes(env.GEMINI_API_KEY, type, "ru", previousThemes, contentMode);

    // Extract short names for poll, keep full strings for storage
    const shortNames = themesRaw.map((t) => parseTheme(t).short);

    // Validate: need at least 2 options for poll
    if (shortNames.length < 2) {
      console.error(`generatePoll: not enough themes for ${type}`);
      return;
    }

    const poll = await tg.sendPoll(
      config.chatId,
      ru.pollQuestion(type),
      shortNames,
      {
        message_thread_id: topicId || undefined,
        is_anonymous: false,
        allows_multiple_answers: false,
      },
    );

    await storage.savePoll({
      type,
      pollId: poll.poll.id,
      messageId: poll.message_id,
      options: themesRaw, // Store full "short | full" strings
      createdAt: Date.now(),
      topicThreadId: topicId,
    });

    // Pin the poll
    try {
      await tg.pinChatMessage(config.chatId, poll.message_id);
    } catch (e) {
      console.error("Failed to pin poll:", e.message);
    }

    console.log(`Poll created and pinned: ${type}`);
  } catch (e) {
    console.error(`generatePoll error (${type}):`, {
      error: e.message,
      stack: e.stack,
    });
  }
}

async function finishChallenge(env, config, tg, storage, type) {
  try {
    const challenge = await storage.getChallenge(type);
    if (!challenge || challenge.status !== "active") return;

    // Unpin the announcement
    if (challenge.announcementMessageId) {
      try {
        await tg.unpinChatMessage(config.chatId, challenge.announcementMessageId);
      } catch (e) {
        console.error("Failed to unpin announcement:", e.message);
      }
    }

    const submissions = await storage.getSubmissions(type, challenge.id);

    if (submissions.length === 0) {
      await tg.sendMessage(config.chatId, ru.noSubmissions, {
        message_thread_id: challenge.topicThreadId || undefined,
      });
    } else {
      // Find max score and all winners with that score
      const maxScore = Math.max(...submissions.map((s) => s.score));
      const winners = submissions.filter((s) => s.score === maxScore);

      // Format winner names
      const winnerNames = winners
        .map((w) => (w.username ? `@${w.username}` : `–£—á–∞—Å—Ç–Ω–∏–∫ #${w.userId}`))
        .join(", ");

      await tg.sendMessage(
        config.chatId,
        ru.winnerAnnouncement(winnerNames, maxScore, type),
        {
          message_thread_id: challenge.topicThreadId || undefined,
          reply_to_message_id: winners[0].messageId,
        },
      );

      // Forward all winners to winners topic and add wins
      for (const winner of winners) {
        if (config.topics.winners) {
          try {
            await tg.forwardMessage(
              config.chatId,
              config.chatId,
              winner.messageId,
              {
                message_thread_id: config.topics.winners,
              },
            );
            const winnerName = winner.username
              ? `@${winner.username}`
              : `–£—á–∞—Å—Ç–Ω–∏–∫ #${winner.userId}`;
            await tg.sendMessage(
              config.chatId,
              ru.winnerAnnouncementFull(winnerName, winner.score, type, challenge.topic, challenge.topicFull || challenge.topic),
              {
                message_thread_id: config.topics.winners,
              },
            );
          } catch (e) {
            console.error("Forward error:", e);
          }
        }

        await storage.addWin(type, winner.userId, winner.username);
      }
    }

    challenge.status = "finished";
    await storage.saveChallenge(challenge);

    const activeTopics = await storage.getActiveTopics();
    delete activeTopics[challenge.topicThreadId];
    await storage.setActiveTopics(activeTopics);
  } catch (e) {
    console.error(`finishChallenge error (${type}):`, {
      error: e.message,
      stack: e.stack,
    });
  }
}

async function startChallenge(env, config, tg, storage, type) {
  try {
    await finishChallenge(env, config, tg, storage, type);

    const poll = await storage.getPoll(type);
    let shortTheme = "–°–≤–æ–±–æ–¥–Ω–∞—è —Ç–µ–º–∞";
    let fullTheme =
      "–°–≤–æ–±–æ–¥–Ω–∞—è —Ç–µ–º–∞ ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ, –¥–∞–π—Ç–µ –≤–æ–ª—é —Ñ–∞–Ω—Ç–∞–∑–∏–∏!";
    let voteCount = 0;

    if (poll) {
      try {
        const stopped = await tg.stopPoll(config.chatId, poll.messageId);
        let maxVotes = 0;
        let winnerShort = "";

        // Find winner by short name (that's what's in poll options)
        for (const opt of stopped.options) {
          if (opt.voter_count > maxVotes) {
            maxVotes = opt.voter_count;
            winnerShort = opt.text;
          }
        }
        voteCount = maxVotes;

        // Unpin the poll
        try {
          await tg.unpinChatMessage(config.chatId, poll.messageId);
        } catch (e) {
          console.error("Failed to unpin poll:", e.message);
        }

        // Find matching full theme from stored options
        const matchingFull = poll.options.find(
          (o) => parseTheme(o).short === winnerShort,
        );
        if (matchingFull) {
          const parsed = parseTheme(matchingFull);
          shortTheme = parsed.short;
          fullTheme = parsed.full;
        } else if (winnerShort) {
          shortTheme = winnerShort;
          fullTheme = winnerShort;
        }
      } catch (e) {
        console.error("Poll stop error:", e);
        // Fallback to first option (with safety check)
        if (poll.options && poll.options.length > 0) {
          const parsed = parseTheme(poll.options[0]);
          shortTheme = parsed.short;
          fullTheme = parsed.full;
        }
      }
      await storage.deletePoll(type);
    }

    const topicId = config.topics[type];
    const MS_PER_HOUR = 3600000;
    const durations = {
      daily: 24 * MS_PER_HOUR,
      weekly: 7 * 24 * MS_PER_HOUR,
      monthly: 28 * 24 * MS_PER_HOUR,
    };
    const startedAt = Date.now();
    const endsAt = startedAt + durations[type];

    const dateFormat = { day: "numeric", month: "short" };
    const startDateStr = new Date(startedAt).toLocaleString("ru-RU", dateFormat);
    const endDateStr = new Date(endsAt).toLocaleString("ru-RU", dateFormat);

    const challengeId = await storage.getNextChallengeId(type);

    // Use full description in announcement with vote count
    const announcement = await tg.sendMessage(
      config.chatId,
      ru.challengeAnnouncement(type, fullTheme, startDateStr, endDateStr, voteCount),
      {
        message_thread_id: topicId || undefined,
      },
    );

    // Pin the announcement
    try {
      await tg.pinChatMessage(config.chatId, announcement.message_id);
    } catch (e) {
      console.error("Failed to pin announcement:", e.message);
    }

    // Store short theme for leaderboard/stats display
    await storage.saveChallenge({
      id: challengeId,
      type,
      topic: shortTheme,
      topicFull: fullTheme,
      status: "active",
      startedAt: Date.now(),
      endsAt,
      topicThreadId: topicId,
      announcementMessageId: announcement.message_id,
    });

    const activeTopics = await storage.getActiveTopics();
    activeTopics[topicId] = type;
    await storage.setActiveTopics(activeTopics);

    // Save theme to history (to avoid repetition in future)
    await storage.addThemeToHistory(type, shortTheme);

    console.log(`Challenge started: ${type} #${challengeId} - "${shortTheme}" (${voteCount} votes)`);
  } catch (e) {
    console.error(`startChallenge error (${type}):`, {
      error: e.message,
      stack: e.stack,
    });
  }
}

async function handleCron(env, config, tg, storage, cron) {
  try {
    const [, hour, day, weekday] = cron.split(" ");
    const h = parseInt(hour, 10);
    const d = parseInt(day, 10);
    const w = parseInt(weekday, 10);

    console.log(`Cron: ${cron}`);

    // Get schedule from KV
    const schedule = await getSchedule(storage);
    const pollHourBefore = 12; // Poll starts 12 hours before challenge

    // Daily challenge
    const dailyPollHour = (schedule.daily.challengeHour - pollHourBefore + 24) % 24;
    if (h === dailyPollHour && day === "*" && weekday === "*") {
      await generatePoll(env, config, tg, storage, "daily");
    } else if (h === schedule.daily.challengeHour && day === "*" && weekday === "*") {
      await startChallenge(env, config, tg, storage, "daily");
    }

    // Weekly challenge
    const weeklyPollDay = (schedule.weekly.challengeDay + 6) % 7; // Day before
    if (h === schedule.weekly.pollHour && w === weeklyPollDay) {
      await generatePoll(env, config, tg, storage, "weekly");
    } else if (h === schedule.weekly.challengeHour && w === schedule.weekly.challengeDay) {
      await startChallenge(env, config, tg, storage, "weekly");
    }

    // Monthly challenge
    const monthlyPollDay = schedule.monthly.challengeDay === 1 ? 28 : schedule.monthly.challengeDay - 3;
    if (h === schedule.monthly.pollHour && d === monthlyPollDay) {
      await generatePoll(env, config, tg, storage, "monthly");
    } else if (h === schedule.monthly.challengeHour && d === schedule.monthly.challengeDay) {
      await startChallenge(env, config, tg, storage, "monthly");
    }
  } catch (e) {
    console.error("handleCron error:", {
      error: e.message,
      stack: e.stack,
      cron,
    });
  }
}

// ============================================
// MAIN HANDLER
// ============================================

export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    // Health check
    if (url.pathname === "/" || url.pathname === "/health") {
      return new Response(
        JSON.stringify({
          status: "ok",
          bot: "TG Challenge Bot",
          version: "2.4.0",
        }),
        {
          headers: { "Content-Type": "application/json" },
        },
      );
    }

    // Setup webhook (protected with ADMIN_SECRET)
    if (url.pathname === "/setup") {
      try {
        // Check authorization
        const authHeader = request.headers.get("Authorization");
        if (env.ADMIN_SECRET && authHeader !== `Bearer ${env.ADMIN_SECRET}`) {
          return new Response(JSON.stringify({ error: "Unauthorized" }), {
            status: 401,
            headers: { "Content-Type": "application/json" },
          });
        }

        if (!env.BOT_TOKEN) {
          return new Response(
            JSON.stringify({ error: "BOT_TOKEN not configured" }),
            {
              status: 500,
              headers: { "Content-Type": "application/json" },
            },
          );
        }

        const tg = new TelegramAPI(env.BOT_TOKEN);
        const webhookUrl = `${url.origin}/webhook`;
        await tg.setWebhook(webhookUrl, env.WEBHOOK_SECRET || null);

        return new Response(
          JSON.stringify({ success: true, webhook: webhookUrl }),
          {
            headers: { "Content-Type": "application/json" },
          },
        );
      } catch (e) {
        console.error("Setup error:", e);
        return new Response(JSON.stringify({ error: e.message }), {
          status: 500,
          headers: { "Content-Type": "application/json" },
        });
      }
    }

    // ============================================
    // ADMIN ENDPOINTS (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    // ============================================

    // POST /admin/poll/daily|weekly|monthly - —Å–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å
    if (url.pathname.startsWith("/admin/poll/") && request.method === "POST") {
      const authHeader = request.headers.get("Authorization");
      if (env.ADMIN_SECRET && authHeader !== `Bearer ${env.ADMIN_SECRET}`) {
        return new Response(JSON.stringify({ error: "Unauthorized" }), {
          status: 401,
          headers: { "Content-Type": "application/json" },
        });
      }

      const type = url.pathname.split("/").pop();
      if (!["daily", "weekly", "monthly"].includes(type)) {
        return new Response(JSON.stringify({ error: "Invalid type. Use: daily, weekly, monthly" }), {
          status: 400,
          headers: { "Content-Type": "application/json" },
        });
      }

      try {
        const tg = new TelegramAPI(env.BOT_TOKEN);
        const storage = new Storage(env.CHALLENGE_KV);
        const config = await getConfigWithTopics(env, storage);

        // Delete existing poll if any
        await storage.deletePoll(type);
        await generatePoll(env, config, tg, storage, type);

        return new Response(JSON.stringify({ success: true, action: "poll", type }), {
          headers: { "Content-Type": "application/json" },
        });
      } catch (e) {
        return new Response(JSON.stringify({ error: e.message }), {
          status: 500,
          headers: { "Content-Type": "application/json" },
        });
      }
    }

    // POST /admin/start/daily|weekly|monthly - –∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂
    if (url.pathname.startsWith("/admin/start/") && request.method === "POST") {
      const authHeader = request.headers.get("Authorization");
      if (env.ADMIN_SECRET && authHeader !== `Bearer ${env.ADMIN_SECRET}`) {
        return new Response(JSON.stringify({ error: "Unauthorized" }), {
          status: 401,
          headers: { "Content-Type": "application/json" },
        });
      }

      const type = url.pathname.split("/").pop();
      if (!["daily", "weekly", "monthly"].includes(type)) {
        return new Response(JSON.stringify({ error: "Invalid type. Use: daily, weekly, monthly" }), {
          status: 400,
          headers: { "Content-Type": "application/json" },
        });
      }

      try {
        const tg = new TelegramAPI(env.BOT_TOKEN);
        const storage = new Storage(env.CHALLENGE_KV);
        const config = await getConfigWithTopics(env, storage);

        await startChallenge(env, config, tg, storage, type);

        return new Response(JSON.stringify({ success: true, action: "start", type }), {
          headers: { "Content-Type": "application/json" },
        });
      } catch (e) {
        return new Response(JSON.stringify({ error: e.message }), {
          status: 500,
          headers: { "Content-Type": "application/json" },
        });
      }
    }

    // POST /admin/finish/daily|weekly|monthly - –∑–∞–≤–µ—Ä—à–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂
    if (url.pathname.startsWith("/admin/finish/") && request.method === "POST") {
      const authHeader = request.headers.get("Authorization");
      if (env.ADMIN_SECRET && authHeader !== `Bearer ${env.ADMIN_SECRET}`) {
        return new Response(JSON.stringify({ error: "Unauthorized" }), {
          status: 401,
          headers: { "Content-Type": "application/json" },
        });
      }

      const type = url.pathname.split("/").pop();
      if (!["daily", "weekly", "monthly"].includes(type)) {
        return new Response(JSON.stringify({ error: "Invalid type. Use: daily, weekly, monthly" }), {
          status: 400,
          headers: { "Content-Type": "application/json" },
        });
      }

      try {
        const tg = new TelegramAPI(env.BOT_TOKEN);
        const storage = new Storage(env.CHALLENGE_KV);
        const config = await getConfigWithTopics(env, storage);

        await finishChallenge(env, config, tg, storage, type);

        return new Response(JSON.stringify({ success: true, action: "finish", type }), {
          headers: { "Content-Type": "application/json" },
        });
      } catch (e) {
        return new Response(JSON.stringify({ error: e.message }), {
          status: 500,
          headers: { "Content-Type": "application/json" },
        });
      }
    }

    // GET /admin/status - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (url.pathname === "/admin/status") {
      const authHeader = request.headers.get("Authorization");
      if (env.ADMIN_SECRET && authHeader !== `Bearer ${env.ADMIN_SECRET}`) {
        return new Response(JSON.stringify({ error: "Unauthorized" }), {
          status: 401,
          headers: { "Content-Type": "application/json" },
        });
      }

      try {
        const storage = new Storage(env.CHALLENGE_KV);
        const [daily, weekly, monthly, pollDaily, pollWeekly, pollMonthly, activeTopics] = await Promise.all([
          storage.getChallenge("daily"),
          storage.getChallenge("weekly"),
          storage.getChallenge("monthly"),
          storage.getPoll("daily"),
          storage.getPoll("weekly"),
          storage.getPoll("monthly"),
          storage.getActiveTopics(),
        ]);

        return new Response(JSON.stringify({
          challenges: { daily, weekly, monthly },
          polls: { daily: !!pollDaily, weekly: !!pollWeekly, monthly: !!pollMonthly },
          activeTopics,
        }, null, 2), {
          headers: { "Content-Type": "application/json" },
        });
      } catch (e) {
        return new Response(JSON.stringify({ error: e.message }), {
          status: 500,
          headers: { "Content-Type": "application/json" },
        });
      }
    }

    // Info (protected with ADMIN_SECRET)
    if (url.pathname === "/info") {
      try {
        const authHeader = request.headers.get("Authorization");
        if (env.ADMIN_SECRET && authHeader !== `Bearer ${env.ADMIN_SECRET}`) {
          return new Response(JSON.stringify({ error: "Unauthorized" }), {
            status: 401,
            headers: { "Content-Type": "application/json" },
          });
        }

        const storage = new Storage(env.CHALLENGE_KV);
        const config = await getConfigWithTopics(env, storage);
        return new Response(
          JSON.stringify({
            configured: !!env.BOT_TOKEN,
            chat_id: config.chatId,
            topics: config.topics,
          }),
          { headers: { "Content-Type": "application/json" } },
        );
      } catch (e) {
        console.error("Info error:", e);
        return new Response(JSON.stringify({ error: e.message }), {
          status: 500,
          headers: { "Content-Type": "application/json" },
        });
      }
    }

    // Webhook
    if (url.pathname === "/webhook" && request.method === "POST") {
      // Verify webhook secret if configured
      if (env.WEBHOOK_SECRET) {
        const secretHeader = request.headers.get(
          "X-Telegram-Bot-Api-Secret-Token",
        );
        if (secretHeader !== env.WEBHOOK_SECRET) {
          return new Response("Forbidden", { status: 403 });
        }
      }

      try {
        const update = await request.json();

        // Webhook deduplication - prevent processing duplicate updates
        if (update.update_id) {
          const dedupKey = `webhook:processed:${update.update_id}`;
          const alreadyProcessed = await env.CHALLENGE_KV.get(dedupKey);
          if (alreadyProcessed) {
            console.log(`Skipping duplicate update ${update.update_id}`);
            return new Response("OK");
          }
          // Mark as processed (TTL: 1 hour)
          await env.CHALLENGE_KV.put(dedupKey, "1", { expirationTtl: 3600 });
        }

        const tg = new TelegramAPI(env.BOT_TOKEN);
        const storage = new Storage(env.CHALLENGE_KV);
        const config = await getConfigWithTopics(env, storage);

        if (update.message) {
          await handleMessage(update, env, config, tg, storage);
        } else if (update.message_reaction) {
          await handleReaction(update, env, config, storage);
        } else if (update.message_reaction_count) {
          await handleReactionCount(update, env, config, storage);
        }
      } catch (e) {
        console.error("Webhook error:", {
          error: e.message,
          stack: e.stack,
        });
      }

      return new Response("OK");
    }

    return new Response("Not found", { status: 404 });
  },

  async scheduled(event, env) {
    try {
      if (!env.BOT_TOKEN || !env.CHAT_ID) {
        console.error("Scheduled job skipped: missing BOT_TOKEN or CHAT_ID");
        return;
      }

      const tg = new TelegramAPI(env.BOT_TOKEN);
      const storage = new Storage(env.CHALLENGE_KV);
      const config = await getConfigWithTopics(env, storage);

      await handleCron(env, config, tg, storage, event.cron);
    } catch (e) {
      console.error("Scheduled job error:", {
        error: e.message,
        stack: e.stack,
        cron: event.cron,
        scheduledTime: event.scheduledTime,
      });
    }
  },
};
